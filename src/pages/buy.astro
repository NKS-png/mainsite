---
import { supabase } from '../lib/supabase';
import '../styles/global.css';

// No authentication required for viewing cart/buy page
// Users can place orders as guests
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Buy Services - NKScreates</title>
	</head>
	<body>

		<!-- Header -->
		<header class="site-header">
			<div class="header-content">
				<div class="logo">
					<h1>NKScreates</h1>
				</div>
				<nav class="main-nav">
					<a href="/" class="nav-link">Home</a>
					<a href="/dashboard" class="nav-link">Dashboard</a>
					<a href="#cart" class="nav-link active">Buy Services</a>
				</nav>
				<div class="header-actions">
					<button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
						<svg class="sun-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
							<circle cx="12" cy="12" r="5"/>
							<path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
						</svg>
						<svg class="moon-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
							<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
						</svg>
					</button>

				</div>
			</div>
		</header>

		<!-- Main Content -->
		<main>
			<section class="buy-section" id="cart">
				<div class="section-container">
					<div class="section-header">
						<h1 class="section-title">Your Cart</h1>
						<p class="section-subtitle">Review and purchase the services you've selected</p>
					</div>

					<!-- Cart Items -->
					<div class="cart-container">
						<div class="cart-items" id="cartItems">
							<!-- Cart items will be populated by JavaScript -->
							<div class="empty-cart">
								<div class="empty-cart-icon">
									<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
										<path d="M3 3h18l-1 16H4L3 3z" stroke="currentColor" stroke-width="2"/>
										<path d="M8 3V1a1 1 0 011-1h6a1 1 0 011 1v2M9 11v6M12 11v6M15 11v6" stroke="currentColor" stroke-width="2"/>
									</svg>
								</div>
								<h3>Your cart is empty</h3>
								<p>Add some services from the dashboard to get started</p>
								<a href="/dashboard" class="cta-primary">Browse Services</a>
							</div>
						</div>

						<!-- Cart Summary -->
						<div class="cart-summary" id="cartSummary" style="display: none;">
							<div class="summary-card">
								<h3>Order Summary</h3>
								<div class="summary-row">
									<span>Subtotal:</span>
									<span id="subtotal">₹0</span>
								</div>
								<div class="summary-row">
									<span>Tax (18% GST):</span>
									<span id="tax">₹0</span>
								</div>
								<div class="summary-divider"></div>
								<div class="summary-row total">
									<span>Total:</span>
									<span id="total">₹0</span>
								</div>
								<button class="cta-primary full-width" id="checkoutBtn" onclick="proceedToCheckout()">
									Proceed to Checkout
									<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
										<path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
									</svg>
								</button>
							</div>
						</div>
					</div>
				</div>
			</section>
		</main>

		<!-- Scripts -->
		<script src="/cart-manager.js" is:inline></script>
		<script>
			// Initialize cart page
			document.addEventListener('DOMContentLoaded', function() {
				loadCartItems();

				// Handle user menu dropdown
				const userMenuBtn = document.getElementById('userMenu');
				const dropdownMenu = document.getElementById('dropdownMenu');

				if (userMenuBtn && dropdownMenu) {
					userMenuBtn.addEventListener('click', function(e) {
						e.stopPropagation();
						const isVisible = dropdownMenu.style.display === 'block';
						dropdownMenu.style.display = isVisible ? 'none' : 'block';
					});

					// Close dropdown when clicking outside
					document.addEventListener('click', function(e) {
						if (!e.target.closest('.user-menu')) {
							dropdownMenu.style.display = 'none';
						}
					});
				}
			});

			// Load and display cart items
			function loadCartItems() {
				const cart = JSON.parse(localStorage.getItem('cart') || '[]');
				const cartItemsContainer = document.getElementById('cartItems');
				const cartSummary = document.getElementById('cartSummary');

				if (cart.length === 0) {
					// Show empty cart message
					cartItemsContainer.innerHTML = `
						<div class="empty-cart">
							<div>
								<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path d="M3 3h18l-1 16H4L3 3z" stroke="currentColor" stroke-width="2"/>
									<path d="M8 3V1a1 1 0 011-1h6a1 1 0 011 1v2M9 11v6M12 11v6M15 11v6" stroke="currentColor" stroke-width="2"/>
								</svg>
							</div>
							<h3>Your cart is empty</h3>
							<p>Add some services from the dashboard to get started</p>
							<a href="/dashboard" class="cta-primary">Browse Services</a>
						</div>
					`;
					cartSummary.style.display = 'none';
					return;
				}

				// Show cart items
				cartSummary.style.display = 'block';
				let subtotal = 0;

				cartItemsContainer.innerHTML = cart.map((item, index) => {
					const itemTotal = item.price * item.quantity;
					subtotal += itemTotal;

					return `
						<div class="cart-item-card">
						<div class="cart-item-header">
							<h4>${item.title}</h4>
							<button onclick="removeFromCart('${item.id}')" class="remove-btn" aria-label="Remove ${item.title}">
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
								</svg>
							</button>
						</div>
						<div class="cart-item-details">
							<div class="quantity-controls">
								<button onclick="updateQuantity('${item.id}', ${item.quantity - 1})" class="qty-btn" ${item.quantity <= 1 ? 'disabled' : ''}>-</button>
								<span class="quantity">${item.quantity}</span>
								<button onclick="updateQuantity('${item.id}', ${item.quantity + 1})" class="qty-btn">+</button>
							</div>
							<div class="price-info">
								<span class="unit-price">₹${item.price.toLocaleString()}</span>
								<span class="item-total">₹${itemTotal.toLocaleString()}</span>
							</div>
						</div>
						<div class="cart-item-actions">
							<a href="/place-order?service=${item.id}&title=${encodeURIComponent(item.title)}&price=${item.price}" class="place-order-btn">
								Place Order
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
								</svg>
							</a>
						</div>
					</div>
					`;
				}).join('');

				// Update summary
				const tax = subtotal * 0.18;
				const total = subtotal + tax;

				document.getElementById('subtotal').textContent = `₹${subtotal.toLocaleString()}`;
				document.getElementById('tax').textContent = `₹${tax.toLocaleString()}`;
				document.getElementById('total').textContent = `₹${total.toLocaleString()}`;
			}

			// Remove item from cart
			function removeFromCart(itemId) {
				const cart = JSON.parse(localStorage.getItem('cart') || '[]');
				const updatedCart = cart.filter(item => item.id !== itemId);
				localStorage.setItem('cart', JSON.stringify(updatedCart));
				loadCartItems();
				updateCartBadge();
			}

			// Update item quantity
			function updateQuantity(itemId, newQuantity) {
				if (newQuantity < 1) return;

				const cart = JSON.parse(localStorage.getItem('cart') || '[]');
				const item = cart.find(item => item.id === itemId);
				if (item) {
					item.quantity = newQuantity;
					localStorage.setItem('cart', JSON.stringify(cart));
					loadCartItems();
					updateCartBadge();
				}
			}

			// Update cart badge (copied from cart-manager)
			function updateCartBadge() {
				const cart = JSON.parse(localStorage.getItem('cart') || '[]');
				const itemCount = cart.reduce((count, item) => count + item.quantity, 0);
				// This would update a badge if we had one on this page
			}

			// Proceed to checkout
			function proceedToCheckout() {
				alert('Checkout functionality will be implemented with payment integration. For now, your order has been saved.');
				// Here you would typically redirect to a payment processor
			}

			// Logout function
			async function handleLogout() {
				try {
					// Sign out from Supabase if available
					if (typeof supabase !== 'undefined') {
						const { error } = await supabase.auth.signOut();
						if (error) {
							console.error('Logout error:', error);
						}
					}

					// Clear local data
					localStorage.removeItem('user');
					localStorage.removeItem('cart');

					// Show logout message
					alert('Logged out successfully!');

					// Redirect to home
					window.location.href = '/';
				} catch (error) {
					console.error('Unexpected logout error:', error);
					// Fallback: clear local data anyway
					localStorage.removeItem('user');
					localStorage.removeItem('cart');
					alert('Logged out successfully!');
					window.location.href = '/';
				}
			}
		</script>

		<style>
			/* Buy Page Styles */
			.buy-section {
				padding: var(--spacing-20) 0;
				min-height: 60vh;
			}

			.cart-container {
				display: grid;
				grid-template-columns: 1fr 350px;
				gap: var(--spacing-8);
				align-items: start;
			}

			.cart-items {
				background: var(--bg-primary);
				border-radius: var(--radius-xl);
				padding: var(--spacing-6);
				min-height: 400px;
			}

			.empty-cart {
				text-align: center;
				padding: var(--spacing-12) var(--spacing-6);
			}


			.empty-cart h3 {
				color: var(--text-primary);
				margin-bottom: var(--spacing-2);
			}

			.empty-cart p {
				color: var(--text-secondary);
				margin-bottom: var(--spacing-6);
			}

			.cart-item-card {
				background: var(--bg-secondary);
				border-radius: var(--radius-lg);
				padding: var(--spacing-6);
				margin-bottom: var(--spacing-4);
				border: 1px solid var(--border-color);
			}

			.cart-item-header {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
				margin-bottom: var(--spacing-4);
			}

			.cart-item-header h4 {
				margin: 0;
				color: var(--text-primary);
			}

			.remove-btn {
				background: none;
				border: none;
				color: var(--text-tertiary);
				cursor: pointer;
				padding: var(--spacing-1);
				border-radius: var(--radius-md);
				transition: all var(--transition-fast);
			}

			.remove-btn:hover {
				background: rgba(239, 68, 68, 0.1);
				color: #EF4444;
			}

			.cart-item-details {
				display: flex;
				justify-content: space-between;
				align-items: center;
			}

			.quantity-controls {
				display: flex;
				align-items: center;
				gap: var(--spacing-3);
			}

			.qty-btn {
				width: 32px;
				height: 32px;
				border: 1px solid var(--border-color);
				background: var(--bg-primary);
				color: var(--text-primary);
				border-radius: var(--radius-md);
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: all var(--transition-fast);
			}

			.qty-btn:hover:not(:disabled) {
				border-color: var(--primary-color);
				color: var(--primary-color);
			}

			.qty-btn:disabled {
				opacity: 0.5;
				cursor: not-allowed;
			}

			.quantity {
				font-weight: var(--font-weight-semibold);
				min-width: 24px;
				text-align: center;
			}

			.price-info {
				text-align: right;
			}

			.unit-price {
				display: block;
				color: var(--text-secondary);
				font-size: var(--font-size-sm);
			}

			.item-total {
				display: block;
				color: var(--text-primary);
				font-weight: var(--font-weight-semibold);
				font-size: var(--font-size-lg);
			}

			.cart-item-actions {
				margin-top: var(--spacing-4);
				padding-top: var(--spacing-4);
				border-top: 1px solid var(--border-color);
			}

			.place-order-btn {
				display: inline-flex;
				align-items: center;
				gap: var(--spacing-2);
				padding: var(--spacing-2) var(--spacing-4);
				background: var(--primary-color);
				color: var(--text-inverse);
				text-decoration: none;
				border-radius: var(--radius-md);
				font-size: var(--font-size-sm);
				font-weight: var(--font-weight-medium);
				transition: all var(--transition-fast);
			}

			.place-order-btn:hover {
				background: var(--primary-hover);
				transform: translateY(-1px);
			}

			.cart-summary {
				background: var(--bg-primary);
				border-radius: var(--radius-xl);
				padding: var(--spacing-6);
				border: 1px solid var(--border-color);
				position: sticky;
				top: var(--spacing-6);
			}

			.summary-card h3 {
				margin: 0 0 var(--spacing-4) 0;
				color: var(--text-primary);
			}

			.summary-row {
				display: flex;
				justify-content: space-between;
				margin-bottom: var(--spacing-2);
				color: var(--text-secondary);
			}

			.summary-row.total {
				font-weight: var(--font-weight-bold);
				font-size: var(--font-size-lg);
				color: var(--text-primary);
				margin-top: var(--spacing-4);
				padding-top: var(--spacing-4);
				border-top: 1px solid var(--border-color);
			}

			.summary-divider {
				height: 1px;
				background: var(--border-color);
				margin: var(--spacing-4) 0;
			}

			.full-width {
				width: 100%;
				margin-top: var(--spacing-6);
			}

			/* Responsive */
			@media (max-width: 1024px) {
				.cart-container {
					grid-template-columns: 1fr;
				}

				.cart-summary {
					position: static;
				}
			}
		</style>
	</body>
</html>