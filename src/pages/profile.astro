---
import '../styles/global.css';
import { createSupabaseServerClient } from '../lib/supabase';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

// Check authentication on server-side
const serverSupabase = createSupabaseServerClient(Astro.cookies);
if (!serverSupabase) {
  console.error('Failed to create server Supabase client');
  return Astro.redirect('/login?error=auth_required');
}

// Try multiple methods to get the user
let user = null;
let authMethod = '';

console.log('=== PROFILE AUTH CHECK START ===');

// Method 1: Try getSession
try {
  console.log('Trying getSession...');
  const { data: { session }, error: sessionError } = await serverSupabase.auth.getSession();
  console.log('getSession result:', { hasSession: !!session, hasUser: !!(session?.user), error: sessionError?.message });

  if (session && session.user) {
    user = session.user;
    authMethod = 'session';
    console.log('‚úÖ User authenticated via session:', user.email);
  }
} catch (e) {
  console.log('‚ùå Session method exception:', e);
}

// Method 2: Try getUser directly
if (!user) {
  try {
    console.log('Trying getUser...');
    const { data: { user: userData }, error: userError } = await serverSupabase.auth.getUser();
    console.log('getUser result:', { hasUser: !!userData, error: userError?.message });

    if (userData) {
      user = userData;
      authMethod = 'getUser';
      console.log('‚úÖ User authenticated via getUser:', user.email);
    }
  } catch (e) {
    console.log('‚ùå getUser method exception:', e);
  }
}

// Method 3: Check for custom user session cookie
if (!user) {
  console.log('Checking custom user session cookie...');
  const userSessionCookie = Astro.cookies.get('user_session');
  console.log('Custom cookie exists:', !!userSessionCookie?.value);

  if (userSessionCookie && userSessionCookie.value) {
    try {
      const userData = JSON.parse(userSessionCookie.value);
      console.log('Parsed custom cookie data:', userData);

      user = {
        id: userData.id,
        email: userData.email,
        user_metadata: { name: userData.name || userData.email }
      };
      authMethod = 'custom_cookie';
      console.log('‚úÖ User authenticated via custom cookie:', user.email);
    } catch (e) {
      console.log('‚ùå Custom cookie parsing failed:', e);
    }
  }
}

if (!user) {
  console.error('‚ùå All authentication methods failed - redirecting to login');
  console.log('Available cookies:', Astro.cookies.getAll().map(c => c.name));
  return Astro.redirect('/login?error=not_authenticated');
}

// Try to get profile data from profiles table
let profileData = null;
try {
  const { data: profile, error: profileError } = await serverSupabase
    .from('profiles')
    .select('full_name')
    .eq('id', user.id)
    .single();

  if (!profileError && profile) {
    profileData = profile;
    console.log('‚úÖ Profile data found:', profile);
  } else {
    console.log('‚ùå Profile data not found, creating new profile:', profileError?.message);

    // Create profile record if it doesn't exist
    const { data: newProfile, error: createError } = await serverSupabase
      .from('profiles')
      .upsert({
        id: user.id,
        full_name: user.user_metadata?.full_name ||
                   user.user_metadata?.name ||
                   user.email?.split('@')[0] ||
                   'User'
      })
      .select('full_name')
      .single();

    if (!createError && newProfile) {
      profileData = newProfile;
      console.log('‚úÖ Profile created successfully:', newProfile);
    } else {
      console.log('‚ùå Failed to create profile:', createError?.message);
    }
  }
} catch (e) {
  console.log('‚ùå Error with profile operations:', e);
}

// Make user data available to the template
const userData = {
  id: user.id,
  email: user.email,
  name: profileData?.full_name ||
        user.user_metadata?.full_name ||
        user.user_metadata?.name ||
        user.email?.split('@')[0] ||
        'User'
};

console.log('üìã Final userData for template:', userData);
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Profile Settings - NKScreates</title>
		<style>
			:root {
				--spacing-2: 0.5rem;
				--spacing-3: 0.75rem;
				--spacing-4: 1rem;
				--spacing-6: 1.5rem;
				--spacing-8: 2rem;
				--spacing-12: 3rem;
				--radius-lg: 0.5rem;
				--radius-xl: 0.75rem;
				--radius-2xl: 1rem;
				--radius-full: 9999px;
				--font-size-sm: 0.875rem;
				--font-size-base: 1rem;
				--font-size-lg: 1.125rem;
				--font-size-2xl: 1.5rem;
				--font-size-3xl: 1.875rem;
				--font-weight-medium: 500;
				--font-weight-semibold: 600;
				--font-weight-bold: 700;
				--transition-fast: 0.15s ease-in-out;
			}

			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
				font-size: var(--font-size-base);
				line-height: 1.6;
				color: var(--text-primary, #1f2937);
				background: var(--bg-primary, #ffffff);
				transition: background-color 0.3s;
			}

			[data-theme="dark"] body {
				background: var(--bg-primary, #111827);
				color: var(--text-primary, #f3f4f6);
			}

			.profile-container {
				min-height: 100vh;
				padding-top: 80px;
				background: var(--bg-primary, #ffffff);
			}

			.profile-header {
				background: linear-gradient(135deg, var(--primary-color, #0B79FF), var(--accent-color, #FF6B9D));
				color: white;
				padding: var(--spacing-8) var(--spacing-6);
				text-align: center;
				margin-bottom: var(--spacing-8);
			}

			.profile-header h1 {
				font-size: var(--font-size-3xl);
				font-weight: var(--font-weight-bold);
				margin-bottom: var(--spacing-2);
			}

			.profile-header p {
				font-size: var(--font-size-lg);
				opacity: 0.9;
			}

			.profile-content {
				max-width: 600px;
				margin: 0 auto;
				padding: 0 var(--spacing-6) var(--spacing-12);
			}

			/* Form Sections */
			.form-section {
				background: var(--bg-secondary, #f9fafb);
				border: 1px solid var(--border-color, #e5e7eb);
				border-radius: var(--radius-xl);
				padding: var(--spacing-6);
				margin-bottom: var(--spacing-6);
				transition: all var(--transition-fast);
			}

			[data-theme="dark"] .form-section {
				background: var(--bg-secondary, #1f2937);
				border-color: var(--border-color, #374151);
			}

			.form-section-title {
				font-size: var(--font-size-lg);
				font-weight: var(--font-weight-semibold);
				margin-bottom: var(--spacing-4);
				color: var(--text-primary, #1f2937);
				display: flex;
				align-items: center;
				gap: var(--spacing-2);
			}

			.form-section-title svg {
				width: 20px;
				height: 20px;
				opacity: 0.7;
			}

			/* Info Display */
			.info-display {
				background: var(--bg-primary, #ffffff);
				padding: var(--spacing-4);
				border-radius: var(--radius-lg);
				margin-bottom: var(--spacing-4);
				border: 1px solid var(--border-color, #e5e7eb);
			}

			[data-theme="dark"] .info-display {
				background: var(--bg-primary, #111827);
				border-color: var(--border-color, #374151);
			}

			.info-item {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: var(--spacing-3) 0;
				border-bottom: 1px solid var(--border-color, #e5e7eb);
			}

			[data-theme="dark"] .info-item {
				border-bottom-color: var(--border-color, #374151);
			}

			.info-item:last-child {
				border-bottom: none;
				padding-bottom: 0;
			}

			.info-label {
				font-size: var(--font-size-sm);
				color: var(--text-secondary, #6b7280);
				font-weight: var(--font-weight-medium);
			}

			.info-value {
				color: var(--text-primary, #1f2937);
				font-weight: var(--font-weight-semibold);
				word-break: break-all;
			}

			[data-theme="dark"] .info-value {
				color: var(--text-primary, #f3f4f6);
			}

			/* Form Groups */
			.form-group {
				margin-bottom: var(--spacing-4);
			}

			.form-group:last-child {
				margin-bottom: 0;
			}

			label {
				display: block;
				font-weight: var(--font-weight-medium);
				margin-bottom: var(--spacing-2);
				color: var(--text-primary, #1f2937);
				font-size: var(--font-size-sm);
			}

			input[type="text"],
			input[type="password"],
			input[type="email"] {
				width: 100%;
				padding: var(--spacing-3) var(--spacing-4);
				border: 1px solid var(--border-color, #e5e7eb);
				border-radius: var(--radius-lg);
				font-size: var(--font-size-base);
				transition: all var(--transition-fast);
				background: var(--bg-primary, #ffffff);
				color: var(--text-primary, #1f2937);
			}

			[data-theme="dark"] input[type="text"],
			[data-theme="dark"] input[type="password"],
			[data-theme="dark"] input[type="email"] {
				background: var(--bg-primary, #111827);
				color: var(--text-primary, #f3f4f6);
				border-color: var(--border-color, #374151);
			}

			input[type="text"]:focus,
			input[type="password"]:focus,
			input[type="email"]:focus {
				outline: none;
				border-color: var(--primary-color, #0B79FF);
				box-shadow: 0 0 0 3px rgba(11, 121, 255, 0.1);
			}

			.form-help {
				font-size: var(--font-size-sm);
				color: var(--text-secondary, #6b7280);
				margin-top: var(--spacing-1);
			}

			/* Checkbox */
			.checkbox-group {
				display: flex;
				align-items: center;
				gap: var(--spacing-3);
				padding: var(--spacing-3);
				background: var(--bg-primary, #ffffff);
				border-radius: var(--radius-lg);
				border: 1px solid var(--border-color, #e5e7eb);
			}

			[data-theme="dark"] .checkbox-group {
				background: var(--bg-primary, #111827);
				border-color: var(--border-color, #374151);
			}

			input[type="checkbox"] {
				width: 18px;
				height: 18px;
				cursor: pointer;
				accent-color: var(--primary-color, #0B79FF);
			}

			.checkbox-label {
				margin: 0;
				cursor: pointer;
				user-select: none;
			}

			/* Buttons */
			.button-group {
				display: flex;
				gap: var(--spacing-4);
				flex-wrap: wrap;
				margin-top: var(--spacing-8);
			}

			button {
				font-family: inherit;
				font-size: var(--font-size-base);
				font-weight: var(--font-weight-semibold);
				border-radius: var(--radius-lg);
				transition: all var(--transition-fast);
				cursor: pointer;
				border: none;
				padding: var(--spacing-3) var(--spacing-6);
			}

			.btn-primary {
				background: linear-gradient(135deg, var(--primary-color, #0B79FF), var(--primary-hover, #0966d2));
				color: white;
				flex: 1;
				min-width: 150px;
				box-shadow: 0 4px 12px rgba(11, 121, 255, 0.3);
			}

			.btn-primary:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 16px rgba(11, 121, 255, 0.4);
			}

			.btn-primary:active {
				transform: translateY(0);
			}

			.btn-secondary {
				background: var(--bg-secondary, #f3f4f6);
				color: var(--text-primary, #1f2937);
				border: 1px solid var(--border-color, #e5e7eb);
				flex: 1;
				min-width: 150px;
			}

			[data-theme="dark"] .btn-secondary {
				background: var(--bg-secondary, #1f2937);
				color: var(--text-primary, #f3f4f6);
				border-color: var(--border-color, #374151);
			}

			.btn-secondary:hover {
				background: var(--border-color, #e5e7eb);
				transform: translateY(-2px);
			}

			[data-theme="dark"] .btn-secondary:hover {
				background: var(--border-color, #374151);
			}

			button:disabled {
				opacity: 0.6;
				cursor: not-allowed;
				transform: none !important;
			}

			/* Messages */
			.message {
				padding: var(--spacing-4);
				border-radius: var(--radius-lg);
				margin-top: var(--spacing-4);
				display: none;
				animation: slideIn 0.3s ease-out;
			}

			@keyframes slideIn {
				from {
					opacity: 0;
					transform: translateY(-10px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			.message.show {
				display: block;
			}

			.message-success {
				background: #d1fae5;
				color: #047857;
				border: 1px solid #6ee7b7;
			}

			[data-theme="dark"] .message-success {
				background: rgba(16, 185, 129, 0.15);
				color: #6ee7b7;
				border-color: #047857;
			}

			.message-error {
				background: #fee2e2;
				color: #b91c1c;
				border: 1px solid #fca5a5;
			}

			[data-theme="dark"] .message-error {
				background: rgba(239, 68, 68, 0.15);
				color: #fca5a5;
				border-color: #b91c1c;
			}

			/* Success Animation */
			.success-animation {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.7);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 9999;
				opacity: 0;
				visibility: hidden;
				transition: all 0.3s ease;
			}

			.success-animation.show {
				opacity: 1;
				visibility: visible;
			}

			.checkmark {
				font-size: 80px;
				color: #10b981;
				font-weight: bold;
				animation: checkmarkPulse 2s ease-in-out;
			}

			@keyframes checkmarkPulse {
				0% {
					transform: scale(0.5);
					opacity: 0;
				}
				50% {
					transform: scale(1.2);
					opacity: 1;
				}
				100% {
					transform: scale(1);
					opacity: 1;
				}
			}

			/* Responsive */
			@media (max-width: 640px) {
				.profile-header {
					padding: var(--spacing-6) var(--spacing-4);
					margin-bottom: var(--spacing-6);
				}

				.profile-header h1 {
					font-size: var(--font-size-2xl);
				}

				.profile-header p {
					font-size: var(--font-size-base);
				}

				.profile-content {
					padding: 0 var(--spacing-4) var(--spacing-8);
				}

				.form-section {
					padding: var(--spacing-4);
					margin-bottom: var(--spacing-4);
				}

				.button-group {
					flex-direction: column;
					gap: var(--spacing-3);
					margin-top: var(--spacing-6);
				}

				button {
					padding: var(--spacing-3) var(--spacing-4);
					width: 100%;
				}

				.btn-primary,
				.btn-secondary {
					flex: none;
					min-width: auto;
				}

				.info-item {
					flex-direction: column;
					align-items: flex-start;
					gap: var(--spacing-1);
				}

				.checkmark {
					font-size: 60px;
				}
			}

			/* Theme support */
			[data-theme="dark"] {
				--primary-color: #60a5fa;
				--bg-primary: #111827;
				--bg-secondary: #1f2937;
				--text-primary: #f3f4f6;
				--text-secondary: #d1d5db;
				--border-color: #374151;
			}
		</style>
	</head>
	<body>
		<div class="profile-container">
			<!-- Header -->
			<header class="site-header">
				<div class="header-content">
					<div class="logo-section">
						<a href="/" class="brand-link">
							<h1 class="brand-name">NKScreates</h1>
						</a>
					</div>
					<div class="header-actions">
						<button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
							<svg class="sun-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
								<circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2"/>
								<path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" stroke="currentColor" stroke-width="2"/>
							</svg>
							<svg class="moon-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2"/>
							</svg>
						</button>
						<div class="user-menu-wrapper">
							<button class="user-menu" id="userMenuBtn" aria-label="User menu">
								<div class="welcome-text">
									Hi <span id="userFirstName">User</span>
								</div>
								<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
									<path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
								</svg>
							</button>
							<div class="dropdown-menu" id="dropdownMenu">
								<a href="/profile" class="dropdown-item">
									<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
										<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
										<circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
									</svg>
									Profile
								</a>
								<a href="/orders" class="dropdown-item">
									<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
										<path d="M9 12l2 2 4-4M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke="currentColor" stroke-width="2"/>
									</svg>
									Orders
								</a>
								<div class="dropdown-divider"></div>
								<a href="#" class="dropdown-item logout-item" onclick="handleLogout(event)">
									<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
										<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="2"/>
									</svg>
									Logout
								</a>
							</div>
						</div>
					</div>
				</div>
			</header>

			<!-- Profile Header Section -->
			<div class="profile-header">
				<h1>Profile Settings</h1>
				<p>Manage your account and preferences</p>
			</div>

			<!-- Main Content -->
			<div class="profile-content">
				<!-- Current Information Section -->
				<div class="form-section">
					<div class="form-section-title">
						<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
							<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
							<circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
						</svg>
						Account Information
					</div>
					<div class="info-display">
						<div class="info-item">
							<span class="info-label">Email</span>
							<span class="info-value" id="current-email">-</span>
						</div>
						<div class="info-item">
							<span class="info-label">Display Name</span>
							<span class="info-value" id="current-name">-</span>
						</div>
					</div>
				</div>

				<!-- Update Profile Form -->
				<form id="profile-form">
					<!-- Display Name Section -->
					<div class="form-section">
						<div class="form-section-title">
							<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
								<path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2"/>
								<path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2"/>
							</svg>
							Update Display Name
						</div>
						<div class="form-group">
							<label for="update-name">New Display Name</label>
							<input
								type="text"
								id="update-name"
								placeholder="Enter your new display name"
							/>
							<p class="form-help">How your name will appear on your profile and orders</p>
						</div>
					</div>

					<!-- Password Section -->
					<div class="form-section">
						<div class="form-section-title">
							<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
								<rect x="3" y="11" width="18" height="11" rx="2" stroke="currentColor" stroke-width="2"/>
								<path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2"/>
							</svg>
							Security
						</div>
						<div class="form-group">
							<label for="new-password">New Password</label>
							<input
								type="password"
								id="new-password"
								placeholder="Enter new password (minimum 6 characters)"
								minlength="6"
							/>
							<p class="form-help">Leave blank if you don't want to change it</p>
						</div>
						<div class="form-group">
							<label for="confirm-password">Confirm Password</label>
							<input
								type="password"
								id="confirm-password"
								placeholder="Confirm new password"
							/>
						</div>
					</div>

					<!-- Preferences Section -->
					<div class="form-section">
						<div class="form-section-title">
							<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
								<circle cx="12" cy="12" r="1" stroke="currentColor" stroke-width="2"/>
								<path d="M12 1v6m0 6v6M4.22 4.22l4.24 4.24m5.08 5.08l4.24 4.24M1 12h6m6 0h6M4.22 19.78l4.24-4.24m5.08-5.08l4.24-4.24" stroke="currentColor" stroke-width="2"/>
							</svg>
							Preferences
						</div>
						<div class="checkbox-group">
							<input type="checkbox" id="email-notifications" checked>
							<label for="email-notifications" class="checkbox-label">
								Receive email notifications for orders and updates
							</label>
						</div>
					</div>

					<!-- Action Buttons -->
					<div class="button-group">
						<button type="submit" class="btn-primary" id="update-profile-btn">
							Save Changes
						</button>
						<button type="button" class="btn-secondary" onclick="window.location.href='/'">
							Cancel
						</button>
					</div>

					<!-- Messages -->
					<div id="success-message" class="message message-success">
						‚úì Profile updated successfully!
					</div>
					<div id="error-message" class="message message-error">
						‚úó Error updating profile. Please try again.
					</div>
				</form>
			</div>
		</div>

		<!-- Success Animation -->
		<div id="success-animation" class="success-animation">
			<div class="checkmark">‚úì</div>
		</div>

		<script define:vars={{ userData }}>
			// Make userData available globally
			window.userData = userData;

			// Load current user data
			document.addEventListener('DOMContentLoaded', function() {
				const userData = window.userData || {};
				console.log('Loading user data from window:', userData);

				const emailElement = document.getElementById('current-email');
				const nameElement = document.getElementById('current-name');
				const updateNameInput = document.getElementById('update-name');
				const userFirstName = document.getElementById('userFirstName');

				if (emailElement) emailElement.textContent = userData.email || '';
				if (nameElement) nameElement.textContent = userData.name || '';
				if (updateNameInput) updateNameInput.value = userData.name || '';
				if (userFirstName) userFirstName.textContent = (userData.name || '').split(' ')[0] || 'User';

				// Sync localStorage for client-side scripts
				const storedUser = localStorage.getItem('user');
				if (!storedUser) {
					localStorage.setItem('user', JSON.stringify({
						id: userData.id,
						email: userData.email,
						name: userData.name,
						full_name: userData.name
					}));
				}
			});

			function showSuccessAnimation() {
				const animation = document.getElementById('success-animation');
				animation?.classList.add('show');
			}

			function hideMessage(elementId) {
				const el = document.getElementById(elementId);
				if (el) el.classList.remove('show');
			}

			function showMessage(elementId) {
				const el = document.getElementById(elementId);
				if (el) el.classList.add('show');
			}

			function updateUIWithName(name) {
				const nameElement = document.getElementById('current-name');
				const updateNameInput = document.getElementById('update-name');
				const userFirstName = document.getElementById('userFirstName');

				if (nameElement) nameElement.textContent = name;
				if (updateNameInput) updateNameInput.value = name;
				if (userFirstName) userFirstName.textContent = (name || '').split(' ')[0] || 'User';

				// Update localStorage with the new name
				const userData = window.userData || {};
				userData.name = name;
				userData.full_name = name;
				localStorage.setItem('user', JSON.stringify(userData));
				console.log('Updated localStorage with new name:', userData);
			}

			const profileForm = document.getElementById('profile-form');
			
			if (profileForm) {
				profileForm.addEventListener('submit', async (e) => {
					e.preventDefault();
					console.log('Profile form submitted!');

					const userData = window.userData || {};
					const updateBtn = document.getElementById('update-profile-btn');

					// Hide previous messages
					hideMessage('success-message');
					hideMessage('error-message');

					if (updateBtn) {
						updateBtn.disabled = true;
						updateBtn.textContent = 'Saving...';
					}

					try {
						const updateNameInput = document.getElementById('update-name');
						const newPasswordInput = document.getElementById('new-password');
						const confirmPasswordInput = document.getElementById('confirm-password');

						const newName = updateNameInput?.value?.trim() || '';
						const newPassword = newPasswordInput?.value || '';
						const confirmPassword = confirmPasswordInput?.value || '';

						let updateOccurred = false;

						// Update name if provided
						if (newName && newName !== userData.name) {
							console.log('Updating user name to:', newName);

							const response = await fetch('/api/profile', {
								method: 'PUT',
								headers: {
									'Content-Type': 'application/json',
								},
								body: JSON.stringify({
									full_name: newName
								})
							});

							const result = await response.json();

							if (!response.ok) {
								throw new Error(result.error || 'Failed to update profile');
							}

							console.log('Profile updated successfully:', result);
							updateOccurred = true;
							updateUIWithName(newName);
						}

						// Update password if provided
						if (newPassword) {
							if (newPassword !== confirmPassword) {
								throw new Error('Passwords do not match');
							}

							if (newPassword.length < 6) {
								throw new Error('Password must be at least 6 characters');
							}

							console.log('Updating password...');
							
							const response = await fetch('/api/auth/change-password', {
								method: 'POST',
								headers: {
									'Content-Type': 'application/json',
								},
								body: JSON.stringify({
									newPassword
								})
							});

							const result = await response.json();

							if (!response.ok) {
								throw new Error(result.error || 'Failed to update password');
							}

							console.log('Password updated successfully');
							updateOccurred = true;

							// Clear password fields
							if (newPasswordInput) newPasswordInput.value = '';
							if (confirmPasswordInput) confirmPasswordInput.value = '';
						}

						if (!updateOccurred) {
							throw new Error('No changes made to profile');
						}

						// Show success animation
						showSuccessAnimation();
						showMessage('success-message');

						// Hide animation and reload page after 2.5 seconds
						setTimeout(() => {
							hideMessage('success-message');
							const animation = document.getElementById('success-animation');
							if (animation) animation.classList.remove('show');
							window.location.reload();
						}, 2500);

						console.log('Profile update completed successfully');

					} catch (error) {
						console.error('Profile update error:', error);
						showMessage('error-message');
						const errorMsg = error instanceof Error ? error.message : 'Error updating profile. Please try again.';
						const errorEl = document.getElementById('error-message');
						if (errorEl) {
							errorEl.textContent = '‚úó ' + errorMsg;
						}
					} finally {
						if (updateBtn) {
							updateBtn.disabled = false;
							updateBtn.textContent = 'Save Changes';
						}
					}
				});
			}

			// Theme toggle
			document.addEventListener('DOMContentLoaded', function() {
				const themeToggle = document.getElementById('themeToggle');
				const html = document.documentElement;

				// Load saved theme
				const savedTheme = localStorage.getItem('theme') || 'light';
				html.setAttribute('data-theme', savedTheme);

				if (themeToggle) {
					themeToggle.addEventListener('click', function() {
						const currentTheme = html.getAttribute('data-theme');
						const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

						html.setAttribute('data-theme', newTheme);
						localStorage.setItem('theme', newTheme);
					});
				}

				// User menu dropdown
				const userMenuBtn = document.getElementById('userMenuBtn');
				const dropdownMenu = document.getElementById('dropdownMenu');

				if (userMenuBtn && dropdownMenu) {
					userMenuBtn.addEventListener('click', function(e) {
						e.stopPropagation();
						const isVisible = dropdownMenu.classList.contains('show');
						dropdownMenu.classList.toggle('show');
					});

					// Close dropdown when clicking outside
					document.addEventListener('click', function() {
						dropdownMenu.classList.remove('show');
					});
				}
			});

			function handleLogout(event) {
				event.preventDefault();
				// Clear localStorage and redirect
				localStorage.removeItem('user');
				localStorage.removeItem('user_session');
				document.cookie = 'user_session=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
				window.location.href = '/';
			}
		</script>
	</body>
</html>
