---
import { supabase, createSupabaseServerClient } from '../lib/supabase';
import '../styles/global.css';
import Header from '../components/Header.tsx';
import Comments from '../components/Comments.tsx';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;

// Fetch featured portfolio items for the homepage
let uploads = [];
let videoUploads = [];
if (supabase) {
  try {
    // Get general portfolio items
    const { data } = await supabase
      .from('uploads')
      .select('*')
      .eq('public', true)
      .limit(6);
    uploads = data || [];

    // Get video items specifically for hero rotation
    const { data: videos } = await supabase
      .from('uploads')
      .select('*')
      .eq('public', true)
      .like('mime', 'video/%')
      .limit(10); // Get up to 10 videos for rotation
    videoUploads = videos || [];
  } catch (error) {
    console.error('Failed to fetch portfolio items:', error);
  }
}

// Check for user session to display email or display name in header
// But skip if we're coming from a logout redirect
const isLogout = Astro.url.searchParams.has('logout');
let userEmail = null;
let displayName = null;

if (!isLogout) {
  const serverSupabase = createSupabaseServerClient(Astro.cookies);
  if (serverSupabase) {
    const { data: { session } } = await serverSupabase.auth.getSession();
    if (session?.user) {
      userEmail = session.user.email;
      
      // Fetch display name from profiles table
      try {
        const { data: profile } = await serverSupabase
          .from('profiles')
          .select('full_name')
          .eq('id', session.user.id)
          .single();
        
        if (profile?.full_name) {
          displayName = profile.full_name;
        }
      } catch (error) {
        console.log('Failed to fetch profile display name:', error);
      }
    }
  }
}

const portfolioItems = uploads.map((item, index) => ({
  id: item.id,
  title: item.filename || 'Portfolio Item',
  category: item.bucket === 'video_editing' ? 'Video Editing' :
            item.bucket === 'animation' ? 'Animation' : 'Digital Art',
  bucket: item.bucket,
  thumbnail: item.mime.startsWith('video/') ?
    `${supabaseUrl}/storage/v1/object/public/${item.bucket}/${encodeURIComponent(item.path)}` :
    `${supabaseUrl}/storage/v1/object/public/${item.bucket}/${encodeURIComponent(item.path)}`,
  image: item.thumbnail || item.image,
  description: '',
  mime: item.mime
}));
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>NKScreates - Professional Animation & Digital Art</title>
    <meta name="description" content="Professional animation, video editing, and digital artwork services. Transform your vision into stunning visual experiences." />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.13.0/gsap.min.js"></script>
    <style>
      /* Loading Screen Styles */
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #0B79FF, #8b5cf6, #ec4899);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 1;
        transition: opacity 0.5s ease-out;
      }

      .loading-screen.fade-out {
        opacity: 0;
        pointer-events: none;
      }

      .loading-content {
        text-align: center;
        color: white;
      }

      .loading-gif {
        width: 100vw;
        height: 100vh;
        object-fit: cover;
      }

      /* Interactive Bubble Background */
      .bubble-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        pointer-events: none;
        z-index: -1;
        overflow: hidden;
      }

      .bubble {
        position: absolute;
        border-radius: 50%;
        background: linear-gradient(135deg, rgba(11, 121, 255, 0.1), rgba(245, 158, 11, 0.1));
        backdrop-filter: blur(1px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        animation: float 20s ease-in-out infinite;
        transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }

      .bubble:hover {
        transform: scale(1.2);
        background: linear-gradient(135deg, rgba(11, 121, 255, 0.2), rgba(245, 158, 11, 0.2));
      }

      .bubble[data-size="large"] {
        width: 120px;
        height: 120px;
        animation-duration: 25s;
        animation-delay: 0s;
      }

      .bubble[data-size="medium"] {
        width: 80px;
        height: 80px;
        animation-duration: 20s;
        animation-delay: -5s;
      }

      .bubble[data-size="small"] {
        width: 60px;
        height: 60px;
        animation-duration: 15s;
        animation-delay: -10s;
      }

      /* Different bubble positions and paths */
      .bubble:nth-child(1) { top: 10%; left: 10%; animation: float1 25s ease-in-out infinite; }
      .bubble:nth-child(2) { top: 20%; right: 15%; animation: float2 20s ease-in-out infinite; }
      .bubble:nth-child(3) { top: 30%; left: 20%; animation: float3 18s ease-in-out infinite; }
      .bubble:nth-child(4) { top: 15%; right: 25%; animation: float4 22s ease-in-out infinite; }
      .bubble:nth-child(5) { top: 25%; left: 30%; animation: float5 19s ease-in-out infinite; }
      .bubble:nth-child(6) { top: 35%; right: 10%; animation: float6 21s ease-in-out infinite; }
      .bubble:nth-child(7) { top: 5%; left: 40%; animation: float7 24s ease-in-out infinite; }
      .bubble:nth-child(8) { top: 40%; right: 30%; animation: float8 17s ease-in-out infinite; }
      .bubble:nth-child(9) { top: 10%; left: 50%; animation: float9 23s ease-in-out infinite; }
      .bubble:nth-child(10) { top: 45%; right: 5%; animation: float10 20s ease-in-out infinite; }
      .bubble:nth-child(11) { top: 20%; left: 60%; animation: float11 18s ease-in-out infinite; }
      .bubble:nth-child(12) { top: 50%; right: 35%; animation: float12 22s ease-in-out infinite; }
      .bubble:nth-child(13) { top: 30%; left: 70%; animation: float13 19s ease-in-out infinite; }
      .bubble:nth-child(14) { top: 55%; right: 20%; animation: float14 21s ease-in-out infinite; }
      .bubble:nth-child(15) { top: 40%; left: 80%; animation: float15 16s ease-in-out infinite; }

      /* Floating animations with different paths */
      @keyframes float1 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(30px, -40px) rotate(90deg); }
        50% { transform: translate(-20px, -80px) rotate(180deg); }
        75% { transform: translate(40px, -20px) rotate(270deg); }
      }

      @keyframes float2 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(-35px, -30px) rotate(-90deg); }
        50% { transform: translate(25px, -70px) rotate(-180deg); }
        75% { transform: translate(-15px, -10px) rotate(-270deg); }
      }

      @keyframes float3 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(40px, -50px) rotate(120deg); }
        50% { transform: translate(-30px, -90px) rotate(240deg); }
        75% { transform: translate(20px, -30px) rotate(360deg); }
      }

      @keyframes float4 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(-25px, -35px) rotate(-120deg); }
        50% { transform: translate(35px, -65px) rotate(-240deg); }
        75% { transform: translate(-10px, -15px) rotate(-360deg); }
      }

      @keyframes float5 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(45px, -55px) rotate(150deg); }
        50% { transform: translate(-40px, -85px) rotate(300deg); }
        75% { transform: translate(25px, -25px) rotate(450deg); }
      }

      @keyframes float6 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(-30px, -45px) rotate(-150deg); }
        50% { transform: translate(40px, -75px) rotate(-300deg); }
        75% { transform: translate(-20px, -35px) rotate(-450deg); }
      }

      @keyframes float7 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(35px, -40px) rotate(180deg); }
        50% { transform: translate(-25px, -80px) rotate(360deg); }
        75% { transform: translate(30px, -20px) rotate(540deg); }
      }

      @keyframes float8 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(-40px, -50px) rotate(-180deg); }
        50% { transform: translate(30px, -70px) rotate(-360deg); }
        75% { transform: translate(-25px, -40px) rotate(-540deg); }
      }

      @keyframes float9 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(50px, -60px) rotate(210deg); }
        50% { transform: translate(-35px, -95px) rotate(420deg); }
        75% { transform: translate(40px, -30px) rotate(630deg); }
      }

      @keyframes float10 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(-45px, -55px) rotate(-210deg); }
        50% { transform: translate(35px, -85px) rotate(-420deg); }
        75% { transform: translate(-30px, -45px) rotate(-630deg); }
      }

      @keyframes float11 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(55px, -45px) rotate(240deg); }
        50% { transform: translate(-50px, -75px) rotate(480deg); }
        75% { transform: translate(35px, -35px) rotate(720deg); }
      }

      @keyframes float12 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(-50px, -60px) rotate(-240deg); }
        50% { transform: translate(45px, -90px) rotate(-480deg); }
        75% { transform: translate(-40px, -50px) rotate(-720deg); }
      }

      @keyframes float13 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(40px, -35px) rotate(270deg); }
        50% { transform: translate(-45px, -65px) rotate(540deg); }
        75% { transform: translate(50px, -40px) rotate(810deg); }
      }

      @keyframes float14 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(-35px, -40px) rotate(-270deg); }
        50% { transform: translate(50px, -60px) rotate(-540deg); }
        75% { transform: translate(-45px, -55px) rotate(-810deg); }
      }

      @keyframes float15 {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        25% { transform: translate(60px, -50px) rotate(300deg); }
        50% { transform: translate(-55px, -80px) rotate(600deg); }
        75% { transform: translate(45px, -45px) rotate(900deg); }
      }

      /* Dark theme bubble colors */
      [data-theme="dark"] .bubble {
        background: linear-gradient(135deg, rgba(11, 121, 255, 0.15), rgba(245, 158, 11, 0.15));
        border-color: rgba(255, 255, 255, 0.1);
      }

      [data-theme="dark"] .bubble:hover {
        background: linear-gradient(135deg, rgba(11, 121, 255, 0.25), rgba(245, 158, 11, 0.25));
      }

      /* Bubble interaction states */
      .bubble.attracted {
        animation-play-state: paused;
        z-index: 1;
      }

      /* Cursor Follower */
      .cursor-follower {
        position: fixed;
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        border-radius: 50%;
        pointer-events: none;
        z-index: 1070;
        transition: transform 0.1s ease-out;
        box-shadow: 0 0 20px rgba(11, 121, 255, 0.6);
        animation: cursorPulse 2s ease-in-out infinite;
        mix-blend-mode: screen;
      }

      .cursor-follower::before {
        content: '';
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        border: 2px solid rgba(245, 158, 11, 0.3);
        border-radius: 50%;
        animation: cursorRing 3s ease-in-out infinite;
      }

      @keyframes cursorPulse {
        0%, 100% {
          transform: scale(1);
          opacity: 0.8;
        }
        50% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      @keyframes cursorRing {
        0% {
          transform: scale(0.5);
          opacity: 1;
        }
        100% {
          transform: scale(2);
          opacity: 0;
        }
      }

      /* Hide cursor follower on touch devices */
      @media (hover: none) and (pointer: coarse) {
        .cursor-follower {
          display: none;
        }
      }

      /* Performance optimization - reduce bubbles on smaller screens */
      @media (max-width: 1024px) {
        .bubble:nth-child(n+10) {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .bubble-background {
          display: none; /* Hide bubbles on mobile for performance */
        }
      }

      /* Reduce motion for accessibility */
      @media (prefers-reduced-motion: reduce) {
        .bubble {
          animation: none;
        }

        .bubble.attracted {
          transform: none !important;
        }
      }
    </style>
  </head>
  <body>

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
      <div class="loading-content">
        <img id="loading-gif" src="/start.gif" alt="Loading..." class="loading-gif">
      </div>
    </div>


    <!-- Header (shared component) -->
    <Header client:load />

    <!-- Modern Hero Section -->
    <section class="landing-hero">
      <div class="hero-background">
        <div class="hero-gradient-1"></div>
        <div class="hero-gradient-2"></div>
        <div class="hero-particles"></div>
      </div>

      <div class="section-container">
        <div class="hero-content">
          <div class="hero-text">
            <h1 class="hero-title">
              <span class="hero-line">Professional</span>
              <span class="hero-line">Animation &</span>
              <span class="hero-line">Digital Art</span>
            </h1>
            <p class="hero-subtitle">
              Transform your vision into stunning visual experiences with cutting-edge animation,
              video editing, and digital artwork services.
            </p>
            <div class="hero-actions">
              <a href="/dashboard" class="cta-primary">
                <span>Explore Portfolio</span>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
              <a href="/services" class="cta-outline">
                <span>View Services</span>
              </a>
              <a href="/about" class="cta-secondary">
                <span>About Me</span>
              </a>
            </div>
          </div>

          <div class="hero-visual">
            <div class="hero-showcase">
              <div class="showcase-item featured">
                <div class="showcase-media" id="hero-media">
                  {videoUploads.length > 0 ? (
                    <video id="hero-video" autoplay muted loop playsinline>
                      <source src={`${supabaseUrl}/storage/v1/object/public/${videoUploads[0].bucket}/${encodeURIComponent(videoUploads[0].path)}`} type={videoUploads[0].mime} />
                    </video>
                  ) : portfolioItems[0] && (
                    portfolioItems[0].mime.startsWith('video/') ? (
                      <video id="hero-video" autoplay muted loop playsinline>
                        <source src={portfolioItems[0].thumbnail} type={portfolioItems[0].mime} />
                      </video>
                    ) : (
                      <img src={portfolioItems[0].thumbnail} alt={portfolioItems[0].title} loading="lazy" />
                    )
                  )}
                </div>
                <div class="showcase-overlay" id="hero-overlay">
                  <span class="showcase-category" id="hero-category">{videoUploads.length > 0 ? (videoUploads[0].bucket === 'video_editing' ? 'Video Editing' : videoUploads[0].bucket === 'animation' ? 'Animation' : 'Digital Art') : (portfolioItems[0]?.category || 'Featured Work')}</span>
                  <h3 class="showcase-title" id="hero-title">{videoUploads.length > 0 ? videoUploads[0].filename : (portfolioItems[0]?.title || 'Portfolio Showcase')}</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>


    <!-- Featured Work -->
    <section class="featured-work">
      <div class="section-container">
        <div class="section-header">
          <h2 class="section-title">Featured Work</h2>
          <p class="section-subtitle">Recent projects that showcase our creative expertise</p>
        </div>

        <div class="work-grid">
          {portfolioItems.slice(1, 4).map((item, index) => (
            <div class="work-item" data-category={item.category.toLowerCase()}>
              <div class="work-media">
                {item.mime.startsWith('video/') ? (
                  <video autoplay muted loop playsinline>
                    <source src={item.thumbnail} type={item.mime} />
                  </video>
                ) : (
                  <img src={item.thumbnail} alt={item.title} loading="lazy" />
                )}
              </div>
              <div class="work-overlay">
                <span class="work-category">{item.category}</span>
                <h3 class="work-title">{item.title}</h3>
              </div>
            </div>
          ))}
        </div>

        <div class="work-cta">
          <a href="/dashboard" class="cta-primary">View Full Portfolio</a>
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="cta-section">
      <div class="section-container">
        <div class="cta-content">
          <h2>Ready to Start Your Project?</h2>
          <p>Let's collaborate to bring your creative vision to life</p>
          <div class="cta-buttons">
            <a href="/services" class="cta-primary">Get Started</a>
            <a href="/about" class="cta-outline">Learn More</a>
          </div>
        </div>
      </div>
    </section>

    <!-- Donation Section -->
    <!-- Donations are optional and support ongoing development -->
    <!-- This section is non-intrusive and highlights community support -->
    <section class="donation-section">
      <div class="section-container">
        <div class="donation-content">
          <div class="donation-icon">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2>Support This Project</h2>
          <p>Your support helps keep this project alive and growing. All donations are optional and go directly toward development, community features, and creating more content.</p>
          <a href="upi://pay?pa=9971158189@pthdfc&pn=NKScreates&am=0&cu=INR" target="_blank" rel="noopener noreferrer" class="donation-button">
            <span>Support with UPI</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </a>
        </div>
      </div>
    </section>

    <!-- Comments Section -->
    <Comments client:load />

    <!-- Interactive Bubble Background -->
    <div class="bubble-background" id="bubbleBackground">
      <div class="bubble" data-size="large"></div>
      <div class="bubble" data-size="medium"></div>
      <div class="bubble" data-size="small"></div>
      <div class="bubble" data-size="large"></div>
      <div class="bubble" data-size="medium"></div>
      <div class="bubble" data-size="small"></div>
      <div class="bubble" data-size="large"></div>
      <div class="bubble" data-size="medium"></div>
      <div class="bubble" data-size="small"></div>
      <div class="bubble" data-size="large"></div>
      <div class="bubble" data-size="medium"></div>
      <div class="bubble" data-size="small"></div>
      <div class="bubble" data-size="large"></div>
      <div class="bubble" data-size="medium"></div>
      <div class="bubble" data-size="small"></div>
    </div>

    <!-- Cursor Follower -->
    <div class="cursor-follower" id="cursorFollower"></div>

    <!-- Loading Screen Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const loadingScreen = document.getElementById('loading-screen');
        const loadingGif = document.getElementById('loading-gif');

        // Set appropriate gif based on screen size
        if (loadingGif) {
          const img = loadingGif as HTMLImageElement;
          if (window.innerWidth <= 768) {
            img.src = '/mobile.gif';
          } else {
            img.src = '/start.gif';
          }
        }

        // Hide loading screen after 2 seconds
        setTimeout(function() {
          if (loadingScreen) {
            loadingScreen.classList.add('fade-out');

            // Remove from DOM after fade animation completes
            setTimeout(function() {
              loadingScreen.style.display = 'none';
            }, 500);
          }
        }, 2000);

      });
    </script>

    <script type="module" src="/scripts/animations.js"></script>

    <!-- Cursor Follower and Bubble Animation Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // ===== CURSOR FOLLOWER =====
        const cursorFollower = document.getElementById('cursorFollower') as HTMLElement;
        let cursorX = 0;
        let cursorY = 0;
        let followerX = 0;
        let followerY = 0;
        let isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

        // Only enable cursor follower on non-touch devices
        if (!isTouchDevice && cursorFollower) {
          document.addEventListener('mousemove', (e) => {
            cursorX = e.clientX;
            cursorY = e.clientY;
          });

          function updateCursorFollower() {
            // Smooth following with easing
            const easing = 0.15;
            followerX += (cursorX - followerX) * easing;
            followerY += (cursorY - followerY) * easing;

            cursorFollower.style.left = `${followerX - 10}px`; // Center the 20px element
            cursorFollower.style.top = `${followerY - 10}px`;

            requestAnimationFrame(updateCursorFollower);
          }

          updateCursorFollower();
        }

        // ===== INTERACTIVE BUBBLE BACKGROUND =====
        const bubbles = document.querySelectorAll('.bubble') as NodeListOf<HTMLElement>;
        let mouseX = 0;
        let mouseY = 0;
        let isMouseMoving = false;

        // Only enable mouse interaction on non-touch devices
        if (!isTouchDevice) {
          document.addEventListener('mousemove', (e) => {
            mouseX = e.clientX;
            mouseY = e.clientY;
            isMouseMoving = true;
          });
        }

        // Reset mouse movement flag
        setInterval(() => {
          isMouseMoving = false;
        }, 100);

        function animateBubbles() {
          // Skip interactive behavior on touch devices
          if (!isTouchDevice) {
            bubbles.forEach((bubble, index) => {
              const bubbleElement = bubble as HTMLElement;
              const rect = bubbleElement.getBoundingClientRect();
              const bubbleCenterX = rect.left + rect.width / 2;
              const bubbleCenterY = rect.top + rect.height / 2;

              const distance = Math.sqrt(
                Math.pow(mouseX - bubbleCenterX, 2) +
                Math.pow(mouseY - bubbleCenterY, 2)
              );

              const maxDistance = 150; // Attraction radius
              const attractionStrength = Math.max(0, 1 - distance / maxDistance);

              if (attractionStrength > 0 && isMouseMoving) {
                const angle = Math.atan2(mouseY - bubbleCenterY, mouseX - bubbleCenterX);
                const moveDistance = attractionStrength * 30; // Max movement distance

                const currentTransform = bubbleElement.style.transform || '';
                const translateX = Math.cos(angle) * moveDistance;
                const translateY = Math.sin(angle) * moveDistance;

                bubbleElement.style.transform = `translate(${translateX}px, ${translateY}px) scale(${1 + attractionStrength * 0.3})`;
                bubbleElement.classList.add('attracted');
              } else {
                // Return to original position smoothly
                bubbleElement.style.transform = '';
                bubbleElement.classList.remove('attracted');
              }
            });
          }

          requestAnimationFrame(animateBubbles);
        }

        // Start the animation loop
        animateBubbles();

        // Add some random movement variation (only on non-touch devices)
        if (!isTouchDevice) {
          bubbles.forEach((bubble, index) => {
            const bubbleElement = bubble as HTMLElement;
            setInterval(() => {
              if (!bubbleElement.classList.contains('attracted')) {
                const randomX = (Math.random() - 0.5) * 20;
                const randomY = (Math.random() - 0.5) * 20;
                const randomRotation = (Math.random() - 0.5) * 10;

                bubbleElement.style.transform = `translate(${randomX}px, ${randomY}px) rotate(${randomRotation}deg)`;
              }
            }, 3000 + index * 500); // Stagger the random movements
          });
        }
      });
    </script>

    <script define:vars={{ videoUploads, supabaseUrl, userEmail, displayName }}>
      // Video rotation functionality
      document.addEventListener('DOMContentLoaded', function() {
        // Update welcome text and localStorage to show display name or email if logged in
        if (userEmail) {
          const nameToDisplay = displayName || userEmail;
          const firstNameOnly = (nameToDisplay || '').split(' ')[0] || userEmail;
          
          // Update localStorage with display name if available
          if (displayName) {
            try {
              const storedUser = localStorage.getItem('user');
              if (storedUser) {
                const userData = JSON.parse(storedUser);
                userData.name = displayName;
                userData.full_name = displayName;
                localStorage.setItem('user', JSON.stringify(userData));
                console.log('Updated localStorage with display name:', displayName);
              } else {
                // Create new user object if doesn't exist
                const newUserData = {
                  id: userEmail,
                  email: userEmail,
                  name: displayName,
                  full_name: displayName
                };
                localStorage.setItem('user', JSON.stringify(newUserData));
                console.log('Created new localStorage user with display name:', displayName);
              }
            } catch (e) {
              console.log('Failed to update localStorage with display name:', e);
            }
          }
          
          const updateWelcomeText = () => {
            const welcomeText = document.getElementById('welcomeText');
            if (welcomeText) {
              welcomeText.textContent = `Hi, ${firstNameOnly}`;
            }
          };

          // Try immediately and then poll briefly to catch React hydration
          updateWelcomeText();
          
          const interval = setInterval(() => {
            updateWelcomeText();
          }, 100);
          setTimeout(() => clearInterval(interval), 3000);
        }

        if (videoUploads && videoUploads.length > 1) {
          const heroVideo = document.getElementById('hero-video');
          const heroCategory = document.getElementById('hero-category');
          const heroTitle = document.getElementById('hero-title');

          let currentVideoIndex = 0;
          let rotationInterval;

          function getRandomInterval() {
            // Random interval between 5-10 seconds (5000-10000ms)
            return Math.random() * 5000 + 5000;
          }

          function changeVideo() {
            // Get a random video that's different from current
            let newIndex;
            do {
              newIndex = Math.floor(Math.random() * videoUploads.length);
            } while (newIndex === currentVideoIndex && videoUploads.length > 1);

            currentVideoIndex = newIndex;
            const video = videoUploads[currentVideoIndex];

            // Update video source
            const videoUrl = `${supabaseUrl}/storage/v1/object/public/${video.bucket}/${encodeURIComponent(video.path)}`;
            heroVideo.src = videoUrl;
            heroVideo.load(); // Reload the video

            // Update overlay info
            heroCategory.textContent = video.bucket === 'video_editing' ? 'Video Editing' :
                                     video.bucket === 'animation' ? 'Animation' : 'Digital Art';
            heroTitle.textContent = video.filename;

            // Clear existing interval and set new random one
            clearInterval(rotationInterval);
            rotationInterval = setInterval(changeVideo, getRandomInterval());
          }

          // Start the rotation with initial random interval
          rotationInterval = setInterval(changeVideo, getRandomInterval());

          // Optional: Pause rotation on hover
          const heroShowcase = document.querySelector('.hero-showcase');
          heroShowcase.addEventListener('mouseenter', () => {
            clearInterval(rotationInterval);
          });

          heroShowcase.addEventListener('mouseleave', () => {
            rotationInterval = setInterval(changeVideo, getRandomInterval());
          });
        }
      });
    </script>

  </body>
</html>
