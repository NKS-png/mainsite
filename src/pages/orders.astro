---
import { supabase } from '../lib/supabase';
import Header from '../components/Header.tsx';
import '../styles/global.css';

export const prerender = false;

// For Vercel compatibility, orders will be loaded client-side
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<title>My Orders - NKScreates</title>
		<style>
			.status-pending_approval {
				background: #fef3c7;
				color: #d97706;
				padding: 0.25rem 0.75rem;
				border-radius: 9999px;
				font-size: 0.75rem;
				font-weight: 600;
				text-transform: uppercase;
				display: inline-block;
			}

			.status-approved {
				background: #d1fae5;
				color: #065f46;
				padding: 0.25rem 0.75rem;
				border-radius: 9999px;
				font-size: 0.75rem;
				font-weight: 600;
				text-transform: uppercase;
				display: inline-block;
			}

			.status-rejected {
				background: #fee2e2;
				color: #991b1b;
				padding: 0.25rem 0.75rem;
				border-radius: 9999px;
				font-size: 0.75rem;
				font-weight: 600;
				text-transform: uppercase;
				display: inline-block;
			}

			.status-processing {
				background: #dbeafe;
				color: #1e40af;
				padding: 0.25rem 0.75rem;
				border-radius: 9999px;
				font-size: 0.75rem;
				font-weight: 600;
				text-transform: uppercase;
				display: inline-block;
			}

			.status-completed {
				background: #d1fae5;
				color: #065f46;
				padding: 0.25rem 0.75rem;
				border-radius: 9999px;
				font-size: 0.75rem;
				font-weight: 600;
				text-transform: uppercase;
				display: inline-block;
			}

			.btn-success {
				background: linear-gradient(135deg, #10b981, #059669);
				color: white;
				border: none;
				padding: 0.5rem 1rem;
				border-radius: 0.375rem;
				font-size: 0.875rem;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.2s;
				text-decoration: none;
				display: inline-flex;
				align-items: center;
				gap: 0.25rem;
			}

			.btn-success:hover {
				background: linear-gradient(135deg, #059669, #047857);
				transform: translateY(-1px);
			}
		</style>
	</head>
	<body>
		<Header client:load />
		<main class="orders-container">
			<div style="margin-bottom: 2rem;">
				<h1 style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem; color: var(--text-primary);">My Orders</h1>
				<p style="color: var(--text-secondary);">Track and manage your project orders</p>
			</div>

			<!-- Cart Section -->
			<div id="cartSection" class="cart-section" style="display: none;">
				<div class="order-card">
					<div class="order-header">
						<h3 style="font-size: 1.25rem; font-weight: 600; margin: 0; color: var(--text-primary);">Services Cart</h3>
						<span class="order-status">Ready to Order</span>
					</div>
					<div id="cartItems" class="cart-items-list">
						<!-- Cart items will be populated by JavaScript -->
					</div>
					<div class="cart-actions" style="display:flex; gap:0.75rem; margin-top:1rem;">
						<button id="createOrderBtn" class="btn btn-primary" onclick="createOrderFromCart()">Create Order</button>
						<button class="btn btn-secondary" onclick="clearCart()">Clear Cart</button>
					</div>
				</div>
			</div>

			<div id="ordersContainer">
				<!-- Orders will be loaded here by JavaScript -->
				<div style="text-align: center; padding: 4rem 2rem; background: var(--bg-secondary); border-radius: 1rem; border: 2px dashed var(--border-color);">
					<div style="max-width: 400px; margin: 0 auto;">
						<div class="loading-spinner" style="margin: 0 auto 1.5rem; width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;"></div>
						<h3 style="font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">Loading Orders...</h3>
						<p style="color: var(--text-secondary);">Please wait while we fetch your orders.</p>
					</div>
				</div>
			</div>
		</main>

		<!-- Chat Modal -->
		<div id="chatModal" class="chat-modal-overlay" style="display: none;">
			<div class="chat-modal">
				<div class="chat-header">
					<h3>Chat with NKScreates Team</h3>
					<button onclick="closeChat()" class="chat-close-btn">&times;</button>
				</div>
				<div id="chatMessages" class="chat-messages">
					<!-- Messages will be loaded here -->
				</div>
				<div class="chat-input-area">
					<input type="text" id="chatInput" placeholder="Type your message..." onkeypress="handleChatKeyPress(event)">
					<button onclick="sendChatMessage()" class="chat-send-btn">Send</button>
				</div>
			</div>
		</div>

		<script>
			// Cart functionality for orders page
			let cart = [];

			function loadCart() {
				cart = JSON.parse(localStorage.getItem('services_cart')) || [];
				renderCart();
			}

			function renderCart() {
				const cartSection = document.getElementById('cartSection');
				const cartItems = document.getElementById('cartItems');

				if (cart.length === 0) {
					cartSection.style.display = 'none';
					return;
				}

				cartSection.style.display = 'block';
				cartItems.innerHTML = cart.map(item => `
					<div class="cart-item" style="display:flex; justify-content:space-between; align-items:center; padding:0.75rem; border-bottom:1px solid var(--border-color);">
						<div>
							<h4 style="margin:0; font-size:1rem; color:var(--text-primary);">${item.title}</h4>
							<p style="margin:0.25rem 0 0 0; color:var(--text-secondary); font-size:0.875rem;">₹${item.price}</p>
						</div>
						<button onclick="removeFromCart('${item.id}')" style="background:none; border:none; color:var(--text-tertiary); cursor:pointer; padding:0.25rem;">×</button>
					</div>
				`).join('');
			}

			function removeFromCart(id) {
				cart = cart.filter(item => item.id !== id);
				localStorage.setItem('services_cart', JSON.stringify(cart));
				renderCart();
			}

			function clearCart() {
				cart = [];
				localStorage.removeItem('services_cart');
				renderCart();
			}

			async function createOrderFromCart() {
				if (cart.length === 0) return;

				// Get user info
				let userInfo = {};
				try {
					const stored = JSON.parse(localStorage.getItem('user') || 'null');
					if (stored) {
						userInfo = stored;
					}
				} catch (e) {}

				// Create order for each cart item
				for (const item of cart) {
					const formData = new FormData();
					formData.append('service_id', item.id);
					formData.append('service_title', item.title);
					formData.append('service_price', item.price.toString());
					formData.append('customerName', userInfo.name || '');
					formData.append('customerEmail', userInfo.email || '');
					formData.append('customerPhone', userInfo.phone || '');
					formData.append('description', `Order for ${item.title}`);

					try {
						const res = await fetch('/api/orders', { method: 'POST', body: formData });
						const data = await res.json();
						if (!res.ok) {
							alert(`Failed to create order for ${item.title}: ${data.error}`);
							return;
						}
					} catch (err) {
						console.error(err);
						alert(`Failed to create order for ${item.title}`);
						return;
					}
				}

				// Clear cart and redirect
				clearCart();
				alert('Orders created successfully!');
				window.location.reload();
			}

			function downloadOrderFiles(orderId) {
				// Placeholder for download functionality
				alert(`Download functionality for order #${orderId} will be implemented soon!`);
			}

			// Chat functionality
			let currentChatOrderId = null;

			function openChat(orderId) {
				currentChatOrderId = orderId;
				document.getElementById('chatModal').style.display = 'flex';
				loadChatMessages(orderId);
			}

			function closeChat() {
				document.getElementById('chatModal').style.display = 'none';
				currentChatOrderId = null;
			}

			async function loadChatMessages(orderId) {
				try {
					const response = await fetch(`/api/chat/messages?orderId=${orderId}`);
					const messages = await response.json();

					const chatMessages = document.getElementById('chatMessages');
					chatMessages.innerHTML = messages.map(msg => `
						<div class="chat-message ${msg.sender_type === 'customer' ? 'customer' : 'admin'}">
							<div class="message-content">${msg.message}</div>
							<div class="message-time">${new Date(msg.created_at).toLocaleTimeString()}</div>
						</div>
					`).join('');

					chatMessages.scrollTop = chatMessages.scrollHeight;
				} catch (error) {
					console.error('Failed to load chat messages:', error);
				}
			}

			async function sendChatMessage() {
				const input = document.getElementById('chatInput');
				const message = input.value.trim();

				if (!message || !currentChatOrderId) return;

				try {
					const response = await fetch('/api/chat/send', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({
							orderId: currentChatOrderId,
							message: message,
							senderType: 'customer'
						})
					});

					if (response.ok) {
						input.value = '';
						loadChatMessages(currentChatOrderId);
					}
				} catch (error) {
					console.error('Failed to send message:', error);
				}
			}

			function handleChatKeyPress(event) {
				if (event.key === 'Enter') {
					sendChatMessage();
				}
			}

			// Initialize cart on page load
			document.addEventListener('DOMContentLoaded', loadCart);
		</script>
	</body>
</html>