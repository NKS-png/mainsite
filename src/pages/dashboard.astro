---
import { supabase } from '../lib/supabase';
import '../styles/global.css';
import Header from '../components/Header.tsx';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;

// --- DATA FETCHING ---
let storedUser = null;
let userProfile = null;
try {
	const { data: { user } } = await supabase.auth.getUser();
	storedUser = user || null;

	// Fetch user profile metadata
	if (storedUser) {
		const { data: profile, error: profileError } = await supabase
			.from('profiles')
			.select('full_name, username, is_admin')
			.eq('id', storedUser.id)
			.single();

		if (!profileError && profile) {
			userProfile = profile;
		}
	}
} catch (e) {
	storedUser = null;
	userProfile = null;
}

const { data: uploads, error } = await supabase
	.from('uploads')
	.select('*')
	.eq('public', true)
	.order('created_at', { ascending: false });

if (error) console.error('Supabase Error:', error);

// --- STRICT BUCKET MAPPING ---
const allItems = (uploads || []).map((item) => {
    let filterCat = 'artwork'; // Default
    
    if (item.bucket === 'animation') {
        filterCat = 'animation';
    } else if (item.bucket === 'video_editing') {
        filterCat = 'video';
    } else if (item.bucket === 'artwork') {
        filterCat = 'artwork';
    }

    return {
        id: item.id,
        title: item.filename || 'Untitled',
        category: filterCat === 'video' ? 'Video Edit' : filterCat === 'animation' ? 'Animation' : 'Artwork',
        filterCat: filterCat, // internal filter tag
        src: `${supabaseUrl}/storage/v1/object/public/${item.bucket}/${encodeURIComponent(item.path)}`,
        mime: item.mime,
        bucket: item.bucket,
        rotation: Math.random() * 4 - 2
    };
});

// Reels: Include both videos and images
const baseReelItems = allItems.filter(i => i.mime && (i.mime.startsWith('video/') || i.mime.startsWith('image/')));

// Fallback
if (baseReelItems.length === 0) {
	baseReelItems.push(
		{ id: 'f1', title: 'Demo 1', category: 'Video Edit', filterCat: 'video', src: 'https://cdn.coverr.co/videos/coverr-yellow-ink-in-water-5527/1080p.mp4', mime: 'video/mp4', bucket: 'demo', rotation: 0 },
		{ id: 'f2', title: 'Demo 2', category: 'Video Edit', filterCat: 'video', src: 'https://cdn.coverr.co/videos/coverr-blue-and-yellow-paint-mixing-5528/1080p.mp4', mime: 'video/mp4', bucket: 'demo', rotation: 0 }
	);
}

// Infinite Scroll Array
const infiniteReels = [...baseReelItems, ...baseReelItems, ...baseReelItems, ...baseReelItems];
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>The Feed - NKScreates</title>
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Cabin+Sketch:wght@400;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

		<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

		<script>
			// Mobile detection for performance optimization
			(window as any).isMobile = window.innerWidth <= 768;
		</script>

		<style>
			/* --- THEME --- */
			:root {
				--primary: #2980b9; 
				--accent: #f1c40f; 
				--dark: #1a1a1a;
				--paper: #f4f1ea;
                --card-bg: #ffffff;
                --text-col: #2c3e50;
				
				--font-head: 'Cabin Sketch', cursive;
				--font-body: 'Space Mono', monospace; 
			}

            [data-theme="dark"] {
                --paper: #050a14;
                --dark: #f0f0f0;
                --card-bg: #111827;
                --text-col: #e2e8f0;
                --primary: #5dade2; 
            }

			body {
				font-family: var(--font-body);
				background-color: var(--paper);
				color: var(--text-col);
				margin: 0; padding: 0;
				overflow-x: hidden;
                transition: background-color 0.3s, color 0.3s;
			}

            /* --- LAYOUT UTILS --- */
			.main-container {
				max-width: 1200px; margin: 0 auto;
				padding-top: 6rem; padding-bottom: 4rem;
			}

			h1, h2, h3 { font-family: var(--font-head); letter-spacing: 1px; margin: 0; }

			/* --- 1. THE STASH SECTION --- */
			.section-header { text-align: center; margin-bottom: 2rem; }
            .section-title { font-size: 3rem; color: var(--primary); }
			.stash-section { padding: 2rem; position: relative; }
            
            /* Navigator */
            .stash-navigator {
                display: flex; justify-content: center; gap: 1rem; margin-bottom: 3rem;
                flex-wrap: wrap;
                background: var(--text-col); padding: 5px; border-radius: 50px; width: fit-content; margin-left: auto; margin-right: auto;
            }
            .nav-btn {
                background: transparent; border: none;
                color: var(--paper); padding: 0.8rem 2rem;
                font-family: var(--font-head); font-size: 1.2rem;
                border-radius: 40px; cursor: pointer; transition: all 0.3s;
                opacity: 0.7;
            }
            .nav-btn.active, .nav-btn:hover {
                background: var(--primary); color: #fff; opacity: 1;
                transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }

			.stash-grid {
				display: grid; 
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
				gap: 30px; padding: 20px;
                min-height: 400px;
			}

			.stash-card {
			             position: relative; 
                         width: 100%; height: 0; padding-bottom: 133.33%; /* 3:4 aspect ratio */
			             background: var(--card-bg); 
				border: 2px solid var(--text-col); border-radius: 4px;
			             box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
				transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
			             cursor: pointer;
			             display: none; /* Hidden by default */
			             transform-origin: center center;
                         overflow: hidden;
			}
            
            .stash-card.show { 
                display: block; 
                animation: dealCards 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
            }

            [data-theme="dark"] .stash-card {
                border-color: var(--text-col);
                box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            }
            [data-theme="dark"] .stash-card:hover {
                box-shadow: 0 0 25px var(--primary); border-color: var(--primary);
            }

			.stash-card:hover { 
                transform: scale(1.05) rotate(0deg) !important; 
                z-index: 10; border-color: var(--primary);
            }

			.stash-img, .stash-vid { 
                position: absolute; top: 0; left: 0;
                width: 100%; height: 100%; object-fit: cover; 
                border: none; filter: grayscale(20%); transition: filter 0.3s;
            }
            .stash-card:hover .stash-img, .stash-card:hover .stash-vid { filter: grayscale(0%); }

            .card-meta {
                position: absolute; bottom: 0; left: 0; width: 100%; 
                height: 0; /* No space needed since no content */
                pointer-events: none;
            }
            .card-title {
                font-family: var(--font-head); font-size: 1.2rem; color: var(--text-col); margin: 0;
            }

            @keyframes dealCards {
                from { opacity: 0; transform: translateY(50px) scale(0.9); }
                to { opacity: 1; transform: translateY(0) scale(1); }
            }

            /* --- 3. SOCIAL MEDIA STYLE LIGHTBOX --- */
            .lightbox-modal {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                opacity: 0; visibility: hidden; transition: all 0.3s;
                backdrop-filter: blur(10px);
            }
            .lightbox-modal.active { opacity: 1; visibility: visible; }

            .lightbox-content {
                /* Social media style sizing - fixed frame */
                width: 400px; height: 600px; /* Fixed dimensions for consistent frame */
                display: flex; 
                justify-content: center; 
                align-items: center;
                position: relative;
                transform: scale(0.9); opacity: 0;
                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                border-radius: 12px; 
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                background: #000; /* Black background for letterboxing */
            }
            .lightbox-modal.active .lightbox-content { transform: scale(1); opacity: 1; }

            /* Mobile responsive */
            @media (max-width: 768px) {
                .lightbox-content { 
                    width: 90vw; 
                    height: 70vh;
                }
            }

            .lightbox-media {
                max-width: 100%; max-height: 100%;
                width: auto; height: auto;
                object-fit: contain; /* This ensures full content is visible with black bars if needed */
                display: block; /* Ensure proper display */
                margin: auto; /* Center the media */
            }
            
            /* Compact close button - social media style */
            .lightbox-close {
                position: absolute; top: 15px; right: 15px;
                color: #fff; font-size: 1.5rem; cursor: pointer; 
                background: rgba(0,0,0,0.6); border: none;
                width: 35px; height: 35px; border-radius: 50%;
                display: flex; align-items: center; justify-content: center;
                font-family: var(--font-head);
                z-index: 10001;
                transition: all 0.2s;
                backdrop-filter: blur(5px);
            }
            .lightbox-close:hover { 
                transform: scale(1.1); 
                background: rgba(255,255,255,0.2); 
            }

			/* --- WELCOME SECTION --- */
			.welcome-section {
				text-align: center;
				margin-bottom: 2rem;
			}
			.welcome-section h1 {
				color: var(--primary);
				font-size: 3rem;
				margin: 0 0 1rem 0;
			}
			.welcome-section p {
				color: var(--text-col);
				font-size: 1.1rem;
				max-width: 600px;
				margin: 0 auto;
				opacity: 0.8;
			}

			/* --- USER INFO SECTION --- */
			.user-info-section {
				background: var(--card-bg); border: 2px solid var(--text-col);
				border-radius: 15px; padding: 2rem; margin-bottom: 2rem;
				box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
			}
			[data-theme="dark"] .user-info-section {
				border-color: var(--text-col);
				box-shadow: 0 4px 20px rgba(0,0,0,0.5);
			}
			.user-welcome h3 {
				color: var(--primary); font-size: 1.8rem; margin: 0 0 0.5rem 0;
			}
			.user-welcome p {
				color: var(--text-col); font-size: 1.1rem; margin: 0;
				opacity: 0.8;
			}

			/* --- NAV HUB --- */
			.nav-hub {
				display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-top: 6rem;
			}
			.nav-pill {
				padding: 1rem 2rem; background: var(--card-bg);
				border: 2px solid var(--text-col); border-radius: 50px;
				text-decoration: none; color: var(--text-col); font-weight: bold;
				font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;
				transition: all 0.2s; box-shadow: 4px 4px 0px var(--accent);
			}
			         [data-theme="dark"] .nav-pill { background: var(--card-bg); box-shadow: 4px 4px 0px var(--primary); }
			.nav-pill:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px var(--primary); }


		</style>
	</head>
	<body class="page-dashboard">

		<div class="cursor-follower" id="cursor"></div>
		<div class="cursor-follower" id="cursorFollower"></div>

		<Header client:load />

		<div class="main-container">

			<div class="welcome-section">
				<h1>Welcome to NKScreates</h1>
				<p>Explore our portfolio of digital art, animation, and video editing projects. Scroll through the reel feed and browse the stash to see our latest work.</p>
			</div>

			{storedUser && userProfile ? (
				<div class="user-info-section">
					<div class="user-welcome">
						<h3>Welcome back, {userProfile.full_name || storedUser.email?.split('@')[0] || 'User'}!</h3>
						{userProfile.username ? <p>@{userProfile.username}</p> : null}
					</div>
				</div>
			) : null}

			<div class="section-header" style="margin-top: 4rem;">
				<h2 class="section-title">The Stash</h2>
                
                <div class="stash-navigator">
                    <button class="nav-btn active hover-trigger" data-filter="artwork">Artwork</button>
                    <button class="nav-btn hover-trigger" data-filter="animation">Animation</button>
                    <button class="nav-btn hover-trigger" data-filter="video">Video Editing</button>
                </div>
			</div>

			<div class="stash-grid" id="stashGrid">
				{allItems.length > 0 ? allItems.map((item) => (
					<div
					                   class={`stash-card ${item.filterCat === 'artwork' ? 'show' : ''}`}
					                   data-cat={item.filterCat}
					                   style={`transform: rotate(${item.rotation}deg);`}
					                   onclick={`openLightbox('${item.src}', '${item.mime}')`}
					               >
                        {item.mime.startsWith('video/') ? (
                            <video src={item.src} class="stash-vid" muted loop playsinline onmouseover="this.play()" onmouseout="this.pause()"></video>
                        ) : (
						    <img src={item.src} alt={item.title} class="stash-img" loading="lazy" />
                        )}
                        <div class="card-meta">
                            <!-- File name removed -->
                        </div>
					</div>
				)) : (
					<div style="grid-column: 1/-1; text-align: center; padding: 2rem; border: 2px dashed var(--dark);">
						No items collected yet.
					</div>
				)}
			</div>

			<div class="nav-hub">
				<a href="/services" class="nav-pill hover-trigger"><span>âš¡</span> Services</a>
				<a href="https://www.youtube.com/@itsnks7418" target="_blank" class="nav-pill hover-trigger"><span>â–¶</span> YouTube</a>
				<a href="https://www.instagram.com/nks_919/" target="_blank" class="nav-pill hover-trigger"><span>ðŸ“¸</span> Instagram</a>
				<a href="https://www.fiverr.com/nksbro" target="_blank" class="nav-pill hover-trigger"><span>ðŸ’¼</span> Hire Me</a>
			</div>

		</div>

        <div class="lightbox-modal" id="lightbox" onclick="closeLightbox()">
            <div class="lightbox-content" id="lightboxContent" onclick="event.stopPropagation()">
                <button class="lightbox-close" onclick="closeLightbox()">Ã—</button>
            </div>
        </div>

		<script is:inline>
            // 1. STASH FILTERING
            const filterBtns = document.querySelectorAll('.nav-btn');
            const stashCards = document.querySelectorAll('.stash-card');

            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const filter = btn.dataset.filter;
                    stashCards.forEach(card => {
                        if(card.dataset.cat === filter) {
                            card.classList.add('show');
                        } else {
                            card.classList.remove('show');
                        }
                    });
                });
            });

            // 3. FIXED LIGHTBOX LOGIC
            window.openLightbox = (src, mime) => {
                const lightbox = document.getElementById('lightbox');
                const content = document.getElementById('lightboxContent');
                
                const oldMedia = content.querySelector('.lightbox-media');
                if(oldMedia) oldMedia.remove();

                let el;
                if(mime && mime.startsWith('video/')) {
                    el = document.createElement('video');
                    el.controls = true; 
                    el.autoplay = true;
                    el.muted = true; // Start muted for autoplay
                    el.loop = true;
                } else {
                    el = document.createElement('img');
                }
                
                el.src = src;
                el.className = 'lightbox-media';
                
                // Ensure proper sizing
                el.style.maxWidth = '100%';
                el.style.maxHeight = '100%';
                el.style.objectFit = 'contain';
                el.style.display = 'block';
                
                content.appendChild(el);

                setTimeout(() => lightbox.classList.add('active'), 10);
                document.body.style.overflow = 'hidden';
            };

            window.closeLightbox = () => {
                const lightbox = document.getElementById('lightbox');
                lightbox.classList.remove('active');
                setTimeout(() => {
                    const vid = document.querySelector('.lightbox-media');
                    if(vid && vid.tagName === 'VIDEO') vid.pause();
                    document.body.style.overflow = '';
                }, 300);
            };

			// 4. CURSOR
			const cursor = document.getElementById('cursor');
			const triggers = document.querySelectorAll('.hover-trigger');

			window.addEventListener('mousemove', e => {
				if(cursor) {
					cursor.style.left = e.clientX - 10 + 'px';
					cursor.style.top = e.clientY - 10 + 'px';
				}
			});

			triggers.forEach(el => {
				el.addEventListener('mouseenter', () => cursor && cursor.classList.add('hovered'));
				el.addEventListener('mouseleave', () => cursor && cursor.classList.remove('hovered'));
			});

			window.addEventListener('load', () => {
				// Play dashboard sound
				import('../lib/sound.ts').then(async ({ playDashboardSound }) => {
					await playDashboardSound();
				}).catch(err => console.log('Dashboard sound not available:', err));
			});
		</script>
	</body>
</html>