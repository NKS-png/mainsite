---
import { supabase } from '../lib/supabase';
import '../styles/global.css';
import Header from '../components/Header.tsx';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;

// --- DATA FETCHING ---
let storedUser = null;
try {
	const { data: { user } } = await supabase.auth.getUser();
	storedUser = user || null;
} catch (e) {
	storedUser = null;
}

const { data: uploads, error } = await supabase
	.from('uploads')
	.select('*')
	.eq('public', true)
	.order('created_at', { ascending: false });

if (error) console.error('Supabase Error:', error);

// --- STRICT BUCKET MAPPING ---
const allItems = (uploads || []).map((item) => {
    let filterCat = 'artwork'; // Default
    
    if (item.bucket === 'animation') {
        filterCat = 'animation';
    } else if (item.bucket === 'video_editing') {
        filterCat = 'video';
    } else if (item.bucket === 'artwork') {
        filterCat = 'artwork';
    }

    return {
        id: item.id,
        title: item.filename || 'Untitled',
        category: filterCat === 'video' ? 'Video Edit' : filterCat === 'animation' ? 'Animation' : 'Artwork',
        filterCat: filterCat, // internal filter tag
        src: `${supabaseUrl}/storage/v1/object/public/${item.bucket}/${encodeURIComponent(item.path)}`,
        mime: item.mime,
        bucket: item.bucket,
        rotation: Math.random() * 4 - 2
    };
});

// Reels: Include both videos and images
const baseReelItems = allItems.filter(i => i.mime && (i.mime.startsWith('video/') || i.mime.startsWith('image/')));

// Fallback
if (baseReelItems.length === 0) {
	baseReelItems.push(
		{ id: 'f1', title: 'Demo 1', src: 'https://cdn.coverr.co/videos/coverr-yellow-ink-in-water-5527/1080p.mp4', mime: 'video/mp4' },
		{ id: 'f2', title: 'Demo 2', src: 'https://cdn.coverr.co/videos/coverr-blue-and-yellow-paint-mixing-5528/1080p.mp4', mime: 'video/mp4' }
	);
}

// Infinite Scroll Array
const infiniteReels = [...baseReelItems, ...baseReelItems, ...baseReelItems, ...baseReelItems];
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>The Feed - NKScreates</title>
		
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Cabin+Sketch:wght@400;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

		<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

		<script>
			// Mobile detection for performance optimization
			(window as any).isMobile = window.innerWidth <= 768;
		</script>

		<style>
			/* --- THEME --- */
			:root {
				--primary: #2980b9; 
				--accent: #f1c40f; 
				--dark: #1a1a1a;
				--paper: #f4f1ea;
                --card-bg: #ffffff;
                --text-col: #2c3e50;
				
				--font-head: 'Cabin Sketch', cursive;
				--font-body: 'Space Mono', monospace; 
			}

            [data-theme="dark"] {
                --paper: #050a14;
                --dark: #f0f0f0;
                --card-bg: #111827;
                --text-col: #e2e8f0;
                --primary: #5dade2; 
            }

			body {
				font-family: var(--font-body);
				background-color: var(--paper);
				color: var(--text-col);
				margin: 0; padding: 0;
				overflow-x: hidden;
                transition: background-color 0.3s, color 0.3s;
			}

            /* --- LAYOUT UTILS --- */
			.main-container {
				max-width: 1200px; margin: 0 auto;
				padding-top: 6rem; padding-bottom: 4rem;
			}

			h1, h2, h3 { font-family: var(--font-head); letter-spacing: 1px; margin: 0; }

			/* --- 1. THE REELS DECK --- */
			.section-header { text-align: center; margin-bottom: 2rem; }
            .section-title { font-size: 3rem; color: var(--primary); }

			.reels-wrapper {
                position: relative;
				width: 100%; max-width: 420px;
				margin: 0 auto 4rem;
                height: 85vh; max-height: 900px;
                transition: all 0.3s ease-in-out;
			}

            .reels-wrapper.fullscreen {
                position: fixed; top: 0; left: 0; 
                width: 100vw; height: 100dvh;
                max-width: none; max-height: none;
                z-index: 9999; margin: 0;
                background: #000;
            }

			.reels-container {
                width: 100%; height: 100%;
                border: 4px solid var(--text-col);
				border-radius: 30px;
				background: #000;
				box-shadow: 15px 15px 0px var(--primary);
				overflow-y: scroll;
				scroll-snap-type: y mandatory;
                scroll-behavior: smooth;
				scrollbar-width: none;
			}
            
            .reels-wrapper.fullscreen .reels-container {
                border: none; border-radius: 0; box-shadow: none;
            }

			.reels-container::-webkit-scrollbar { display: none; }

			.reel-item {
				height: 100%; width: 100%;
				scroll-snap-align: center; 
                scroll-snap-stop: always;
				position: relative;
				display: flex; align-items: center; justify-content: center;
				background: #000;
			}

			.reel-video {
				width: 100%; height: 100%;
				object-fit: contain; 
				opacity: 0.6; transition: opacity 0.3s;
			}
			.reel-item.active .reel-video { opacity: 1; }

			.reel-ui {
				position: absolute; bottom: 0; left: 0; width: 100%;
				padding: 20px 20px 40px 20px;
				background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, transparent 100%);
				color: #fff; pointer-events: none; text-align: left;
			}
			.reel-title { font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
			.reel-tag { 
				display: inline-block; background: var(--accent); color: #000; 
				padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; font-weight: bold;
				margin-bottom: 5px;
			}

            .controls-layer {
                position: absolute; top: 20px; right: 20px;
                z-index: 10; display: flex; flex-direction: column; gap: 15px;
                pointer-events: auto;
            }

			.action-btn {
				width: 45px; height: 45px;
				background: rgba(255,255,255,0.15); backdrop-filter: blur(5px);
				border: 2px solid #fff; border-radius: 50%;
				display: flex; align-items: center; justify-content: center;
				color: #fff; cursor: pointer; transition: transform 0.2s; font-size: 1.2rem;
			}
			.action-btn:active { transform: scale(0.9); background: var(--accent); border-color: var(--accent); color: #000; }
            
            .mute-toggle {
                position: absolute; top: 20px; left: 20px; z-index: 10;
                background: rgba(0,0,0,0.5); color: #fff;
                padding: 8px 12px; border-radius: 20px; font-size: 0.8rem;
                display: flex; align-items: center; gap: 8px; cursor: pointer;
                border: 1px solid rgba(255,255,255,0.3);
            }

			/* --- 2. CARD GAME STASH --- */
			.stash-section { padding: 2rem; position: relative; }
            
            /* Navigator */
            .stash-navigator {
                display: flex; justify-content: center; gap: 1rem; margin-bottom: 3rem;
                flex-wrap: wrap;
                background: var(--text-col); padding: 5px; border-radius: 50px; width: fit-content; margin-left: auto; margin-right: auto;
            }
            .nav-btn {
                background: transparent; border: none;
                color: var(--paper); padding: 0.8rem 2rem;
                font-family: var(--font-head); font-size: 1.2rem;
                border-radius: 40px; cursor: pointer; transition: all 0.3s;
                opacity: 0.7;
            }
            .nav-btn.active, .nav-btn:hover {
                background: var(--primary); color: #fff; opacity: 1;
                transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }

			.stash-grid {
				display: grid; 
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
				gap: 40px; padding: 20px;
                min-height: 400px;
			}

			.stash-card {
			             position: relative; aspect-ratio: 3/4;
			             background: var(--card-bg); padding: 10px 10px 50px 10px;
				border: 2px solid var(--text-col); border-radius: 4px;
			             box-shadow: 5px 5px 15px rgba(0,0,0,0.1);
				transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
			             cursor: default;
			             display: none; /* Hidden by default */
			             transform-origin: center center;
			}
            
            .stash-card.show { 
                display: block; 
                animation: dealCards 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
            }

            [data-theme="dark"] .stash-card {
                border-color: var(--text-col);
                box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            }
            [data-theme="dark"] .stash-card:hover {
                box-shadow: 0 0 25px var(--primary); border-color: var(--primary);
            }

			.stash-card:hover { 
                transform: scale(1.05) rotate(0deg) !important; 
                z-index: 10; border-color: var(--primary);
            }

			.stash-img, .stash-vid { 
                width: 100%; height: 100%; object-fit: cover; 
                border: 1px solid #ddd; filter: grayscale(20%); transition: filter 0.3s;
            }
            .stash-card:hover .stash-img, .stash-card:hover .stash-vid { filter: grayscale(0%); }

            .card-meta {
                position: absolute; bottom: 10px; left: 0; width: 100%; text-align: center;
            }
            .card-title {
                font-family: var(--font-head); font-size: 1.2rem; color: var(--text-col); margin: 0;
            }

            @keyframes dealCards {
                from { opacity: 0; transform: translateY(50px) scale(0.9); }
                to { opacity: 1; transform: translateY(0) scale(1); }
            }

            /* --- 3. LIGHTBOX (FIXED 50%) --- */
            .lightbox-modal {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.95); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                opacity: 0; visibility: hidden; transition: all 0.3s;
                backdrop-filter: blur(10px);
            }
            .lightbox-modal.active { opacity: 1; visibility: visible; }

            .lightbox-content {
                /* STRICT SIZING: 50vw MAX width, 85vh MAX height */
                width: auto; height: auto;
                max-width: 50vw; max-height: 85vh;
                display: flex; justify-content: center; align-items: center;
                position: relative;
                transform: scale(0.9); opacity: 0;
                transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }
            .lightbox-modal.active .lightbox-content { transform: scale(1); opacity: 1; }

            /* On Mobile, allow slightly wider */
            @media (max-width: 768px) {
                .lightbox-content { max-width: 90vw; }
            }

            .lightbox-media {
                width: 100%; height: auto;
                max-height: 85vh;
                object-fit: contain; /* Shows full image always */
                border: 3px solid #fff; 
                box-shadow: 0 0 60px rgba(255,255,255,0.1);
                background: #000;
            }
            
            /* CLOSE BUTTON - FIXED ON SCREEN */
            .lightbox-close {
                position: fixed; top: 30px; right: 30px;
                color: #fff; font-size: 3rem; cursor: pointer; 
                background: rgba(0,0,0,0.5); border: 2px solid #fff;
                width: 60px; height: 60px; border-radius: 50%;
                display: flex; align-items: center; justify-content: center;
                font-family: var(--font-head);
                z-index: 10001;
                transition: transform 0.2s;
            }
            .lightbox-close:hover { transform: scale(1.1); background: var(--primary); border-color: var(--primary); }

			/* --- NAV HUB --- */
			.nav-hub {
				display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-top: 6rem;
			}
			.nav-pill {
				padding: 1rem 2rem; background: var(--card-bg);
				border: 2px solid var(--text-col); border-radius: 50px;
				text-decoration: none; color: var(--text-col); font-weight: bold;
				font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;
				transition: all 0.2s; box-shadow: 4px 4px 0px var(--accent);
			}
            [data-theme="dark"] .nav-pill { background: var(--card-bg); box-shadow: 4px 4px 0px var(--primary); }
			.nav-pill:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px var(--primary); }


		</style>
	</head>
	<body class="page-dashboard">

		<div class="cursor-follower" id="cursor"></div>
		<div class="cursor-follower" id="cursorFollower"></div>

		<Header client:load />

		<div class="main-container">
			
			<div class="section-header">
				<h2 class="section-title">The Reel Feed</h2>
				<p>Scroll to Watch</p>
			</div>

			<div class="reels-wrapper" id="reelsWrapper">
                <div class="mute-toggle" onclick="toggleMuteAll()">
                    <span id="muteIcon">ðŸ”‡</span> Unmute
                </div>
                <div class="controls-layer">
                    <button class="action-btn expand-btn" id="expandBtn" title="Fullscreen">â›¶</button>
                </div>

				<div class="reels-container" id="reelsContainer">
					{infiniteReels.map((item, index) => (
						<div class="reel-item" data-index={index}>
							{item.mime.startsWith('video/') ? (
								<video
									class="reel-video"
									src={item.src}
									loop
									playsinline
									muted
									preload="metadata"
								></video>
							) : (
								<img
									class="reel-video"
									src={item.src}
									alt={item.title}
									style="object-fit: contain; background: #000;"
								/>
							)}
							<div class="reel-ui">
								<span class="reel-tag">{item.category}</span>
								<h3 class="reel-title">{item.title}</h3>
							</div>
						</div>
					))}
				</div>
			</div>

			<div class="section-header" style="margin-top: 4rem;">
				<h2 class="section-title">The Stash</h2>
                
                <div class="stash-navigator">
                    <button class="nav-btn active hover-trigger" data-filter="artwork">Artwork</button>
                    <button class="nav-btn hover-trigger" data-filter="animation">Animation</button>
                    <button class="nav-btn hover-trigger" data-filter="video">Video Editing</button>
                </div>
			</div>

			<div class="stash-grid" id="stashGrid">
				{allItems.length > 0 ? allItems.map((item) => (
					<div
					                   class={`stash-card ${item.filterCat === 'artwork' ? 'show' : ''}`}
					                   data-cat={item.filterCat}
					                   style={`transform: rotate(${item.rotation}deg);`}
					               >
                        {item.mime.startsWith('video/') ? (
                            <video src={item.src} class="stash-vid" muted loop playsinline onmouseover="this.play()" onmouseout="this.pause()"></video>
                        ) : (
						    <img src={item.src} alt={item.title} class="stash-img" loading="lazy" />
                        )}
                        <div class="card-meta">
                            <h4 class="card-title">{item.title}</h4>
                        </div>
					</div>
				)) : (
					<div style="grid-column: 1/-1; text-align: center; padding: 2rem; border: 2px dashed var(--dark);">
						No items collected yet.
					</div>
				)}
			</div>

			<div class="nav-hub">
				<a href="/services" class="nav-pill hover-trigger"><span>âš¡</span> Services</a>
				<a href="https://www.youtube.com/@itsnks7418" target="_blank" class="nav-pill hover-trigger"><span>â–¶</span> YouTube</a>
				<a href="https://www.instagram.com/nks_919/" target="_blank" class="nav-pill hover-trigger"><span>ðŸ“¸</span> Instagram</a>
				<a href="https://www.fiverr.com/nksbro" target="_blank" class="nav-pill hover-trigger"><span>ðŸ’¼</span> Hire Me</a>
			</div>

		</div>

        <div class="lightbox-modal" id="lightbox" onclick="closeLightbox()">
            
            <button class="lightbox-close" onclick="closeLightbox()">Ã—</button>

            <div class="lightbox-content" id="lightboxContent" onclick="event.stopPropagation()">
                </div>
        </div>

		<script is:inline>
			// 1. REELS LOGIC
			const initReels = () => {
				const container = document.getElementById('reelsContainer');
				const wrapper = document.getElementById('reelsWrapper');
                const expandBtn = document.getElementById('expandBtn');
                
				let isMuted = true;

				window.toggleMuteAll = () => {
					isMuted = !isMuted;
					document.getElementById('muteIcon').textContent = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
					document.querySelectorAll('.reel-video').forEach(v => v.muted = isMuted);
				};

                expandBtn.addEventListener('click', () => {
                    wrapper.classList.toggle('fullscreen');
                    expandBtn.textContent = wrapper.classList.contains('fullscreen') ? 'âœ•' : 'â›¶';
                });

                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && wrapper.classList.contains('fullscreen')) {
                        wrapper.classList.remove('fullscreen');
                        expandBtn.textContent = 'â›¶';
                    }
                });

				const observer = new IntersectionObserver((entries) => {
					entries.forEach(entry => {
						const media = entry.target.querySelector('video, img');
						const item = entry.target;
						if (entry.isIntersecting) {
							item.classList.add('active');
							// Only handle video-specific logic for videos
							if (media && media.tagName === 'VIDEO') {
								media.muted = isMuted;
								media.currentTime = 0;
								media.play().catch(e => {});
							}
						} else {
							item.classList.remove('active');
							// Only pause videos
							if (media && media.tagName === 'VIDEO') {
								media.pause();
							}
						}
					});
				}, { threshold: 0.6, root: container });

				document.querySelectorAll('.reel-item').forEach(item => observer.observe(item));
			};

            // 2. STASH FILTERING
            const filterBtns = document.querySelectorAll('.nav-btn');
            const stashCards = document.querySelectorAll('.stash-card');

            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const filter = btn.dataset.filter;
                    stashCards.forEach(card => {
                        if(card.dataset.cat === filter) {
                            card.classList.add('show');
                        } else {
                            card.classList.remove('show');
                        }
                    });
                });
            });

            // 3. FIXED LIGHTBOX LOGIC
            window.openLightbox = (src, mime) => {
                const lightbox = document.getElementById('lightbox');
                const content = document.getElementById('lightboxContent');
                
                const oldMedia = content.querySelector('.lightbox-media');
                if(oldMedia) oldMedia.remove();

                let el;
                if(mime && mime.startsWith('video/')) {
                    el = document.createElement('video');
                    el.controls = true; el.autoplay = true;
                } else {
                    el = document.createElement('img');
                }
                
                el.src = src;
                el.className = 'lightbox-media';
                content.appendChild(el);

                setTimeout(() => lightbox.classList.add('active'), 10);
                document.body.style.overflow = 'hidden';
            };

            window.closeLightbox = () => {
                const lightbox = document.getElementById('lightbox');
                lightbox.classList.remove('active');
                setTimeout(() => {
                    const vid = document.querySelector('.lightbox-media');
                    if(vid && vid.tagName === 'VIDEO') vid.pause();
                    document.body.style.overflow = '';
                }, 300);
            };

			// 4. CURSOR
			const cursor = document.getElementById('cursor');
			const triggers = document.querySelectorAll('.hover-trigger');

			window.addEventListener('mousemove', e => {
				if(cursor) {
					cursor.style.left = e.clientX - 10 + 'px';
					cursor.style.top = e.clientY - 10 + 'px';
				}
			});

			triggers.forEach(el => {
				el.addEventListener('mouseenter', () => cursor && cursor.classList.add('hovered'));
				el.addEventListener('mouseleave', () => cursor && cursor.classList.remove('hovered'));
			});

			window.addEventListener('load', () => {
				initReels();
				// Play dashboard sound
				import('../lib/sound.ts').then(async ({ playDashboardSound }) => {
					await playDashboardSound();
				}).catch(err => console.log('Dashboard sound not available:', err));
			});
		</script>
	</body>
</html>