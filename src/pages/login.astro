---
import '../styles/global.css';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<title>Login - NKScreates</title>
	</head>
	<body>
		<!-- Header -->
		<header class="site-header">
			<div class="header-content">
				<div class="logo">
					<h1 onclick="window.location.href='/'" style="cursor: pointer;">NKScreates</h1>
				</div>
				<div class="header-actions">
					<button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
						<svg class="sun-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
							<circle cx="12" cy="12" r="5"/>
							<path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
						</svg>
						<svg class="moon-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
							<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
						</svg>
					</button>
				</div>
			</div>
		</header>

		<!-- Main Content -->
		<main style="min-height: calc(100vh - 80px); display: flex; align-items: center; justify-content: center; padding: var(--spacing-6);">
			<div class="auth-card" style="background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: var(--radius-2xl); padding: var(--spacing-12); max-width: 400px; width: 100%; box-shadow: var(--shadow-xl);">
				<div style="text-align: center; margin-bottom: var(--spacing-8);">
					<div style="width: 80px; height: 80px; margin: 0 auto var(--spacing-6); background: linear-gradient(135deg, var(--primary-color), var(--accent-color)); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: var(--text-inverse); font-size: 32px; font-weight: var(--font-weight-bold);">
						N
					</div>
					<h1 style="font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); margin-bottom: var(--spacing-2); color: var(--text-primary);">Welcome Back</h1>
					<p style="color: var(--text-secondary);">Sign in to your NKScreates account</p>
				</div>

				<form id="login-form" style="display: flex; flex-direction: column; gap: var(--spacing-6);">
					<div class="form-group">
						<label for="email" style="display: block; font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-2); color: var(--text-primary);">Email Address</label>
						<input
							type="email"
							id="email"
							required
							style="width: 100%; padding: var(--spacing-4); border: 2px solid var(--border-color); border-radius: var(--radius-lg); font-size: var(--font-size-base); transition: border-color var(--transition-fast); outline: none;"
							placeholder="Enter your email"
						/>
					</div>

					<div class="form-group">
						<label for="password" style="display: block; font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-2); color: var(--text-primary);">Password</label>
						<input
							type="password"
							id="password"
							required
							style="width: 100%; padding: var(--spacing-4); border: 2px solid var(--border-color); border-radius: var(--radius-lg); font-size: var(--font-size-base); transition: border-color var(--transition-fast); outline: none;"
							placeholder="Enter your password"
						/>
					</div>

					<button
						type="submit"
						id="login-btn"
						style="width: 100%; background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)); color: var(--text-inverse); border: none; padding: var(--spacing-4); border-radius: var(--radius-xl); font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); cursor: pointer; transition: all var(--transition-fast); box-shadow: var(--shadow-lg);"
					>
						Sign In
					</button>
				</form>

				<div style="text-align: center; margin-top: var(--spacing-6); padding-top: var(--spacing-6); border-top: 1px solid var(--border-color);">
					<p style="color: var(--text-secondary); margin-bottom: var(--spacing-4);">
						Don't have an account?
						<a href="/signup" style="color: var(--primary-color); font-weight: var(--font-weight-medium); text-decoration: none; margin-left: var(--spacing-1);">Sign up</a>
					</p>
					<a href="/" style="color: var(--text-tertiary); font-size: var(--font-size-sm); text-decoration: none;">← Back to home</a>
				</div>
			</div>
		</main>

		<!-- Success Animation -->
		<div id="success-animation" class="success-animation">
			<div class="checkmark">✓</div>
		</div>

		<style>
			.success-animation {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.8);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 9999;
				opacity: 0;
				visibility: hidden;
				transition: all 0.5s ease;
			}

			.success-animation.show {
				opacity: 1;
				visibility: visible;
			}

			.checkmark {
				font-size: 120px;
				color: #10b981;
				font-weight: bold;
				animation: checkmarkPulse 2s ease-in-out;
			}

			@keyframes checkmarkPulse {
				0% {
					transform: scale(0.5);
					opacity: 0;
				}
				50% {
					transform: scale(1.2);
					opacity: 1;
				}
				100% {
					transform: scale(1);
					opacity: 1;
				}
			}

			/* Theme Toggle */
			.theme-toggle {
				width: 44px;
				height: 44px;
				border-radius: 50%;
				border: 1px solid var(--border-color);
				background: var(--bg-primary);
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: all 0.3s ease;
				box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
			}

			.theme-toggle:hover {
				border-color: var(--border-hover);
				background: var(--bg-secondary);
				transform: scale(1.05);
			}

			.theme-toggle svg {
				width: 20px;
				height: 20px;
				transition: all 0.3s ease;
			}

			.theme-toggle .moon-icon {
				display: none;
			}

			[data-theme="dark"] .theme-toggle .sun-icon {
				display: none;
			}

			[data-theme="dark"] .theme-toggle .moon-icon {
				display: block;
				color: white;
			}
		</style>

		<script>
			document.addEventListener('DOMContentLoaded', function() {
				document.getElementById('login-form').addEventListener('submit', async (e) => {
					e.preventDefault();
					console.log('Login form submitted');

					const email = document.getElementById('email').value;
					const password = document.getElementById('password').value;
					const submitBtn = document.getElementById('login-btn');

					// Disable button and show loading
					submitBtn.disabled = true;
					submitBtn.textContent = 'Signing In...';

					try {
						const response = await fetch('/api/auth/login', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							},
							body: JSON.stringify({ email, password }),
						});

						const data = await response.json();

						if (!response.ok) {
							throw new Error(data.error || 'Login failed');
						}

						console.log('Login successful:', data);

						// Set user in localStorage for cart manager
						const user = {
							id: data.user.id,
							email: data.user.email,
							name: data.user.email, // Use email as name fallback
							role: data.user.isAdmin ? 'admin' : 'user'
						};
						localStorage.setItem('user', JSON.stringify(user));
						console.log('User stored in localStorage:', user);

						// Show success animation
						showSuccessAnimation();

						// Redirect after animation (add extra delay to ensure cookies are set)
						setTimeout(() => {
							window.location.href = data.redirectTo;
						}, 3000);

					} catch (err) {
						console.error('Login error:', err);

						// Re-enable button
						submitBtn.disabled = false;
						submitBtn.textContent = 'Sign In';

						// Show error message
						if (err.message.includes('Invalid login credentials')) {
							alert('Invalid email or password. If you haven\'t signed up yet, please sign up first.');
						} else if (err.message.includes('Email not confirmed')) {
							alert('Please check your email and confirm your account first');
						} else {
							alert('Login failed: ' + err.message);
						}
					}
				});
			});

			function showSuccessAnimation() {
				const animation = document.getElementById('success-animation');
				animation.classList.add('show');
			}
		</script>
		<script>
			// Theme toggle functionality
			document.addEventListener('DOMContentLoaded', function() {
				const themeToggle = document.getElementById('themeToggle');
				const html = document.documentElement;

				// Load saved theme
				const savedTheme = localStorage.getItem('theme') || 'light';
				html.setAttribute('data-theme', savedTheme);

				if (themeToggle) {
					themeToggle.addEventListener('click', function() {
						const currentTheme = html.getAttribute('data-theme');
						const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

						html.setAttribute('data-theme', newTheme);
						localStorage.setItem('theme', newTheme);
					});
				}

				// Form validation and enhancement
				const form = document.getElementById('login-form');
				const emailInput = document.getElementById('email');
				const passwordInput = document.getElementById('password');
				const submitBtn = document.getElementById('login-btn');

				function validateForm() {
					const isValid = emailInput.value.trim() && passwordInput.value.trim();
					submitBtn.style.opacity = isValid ? '1' : '0.6';
					submitBtn.disabled = !isValid;
				}

				emailInput.addEventListener('input', validateForm);
				passwordInput.addEventListener('input', validateForm);

				// Focus effects
				[emailInput, passwordInput].forEach(input => {
					input.addEventListener('focus', function() {
						this.style.borderColor = 'var(--primary-color)';
					});
					input.addEventListener('blur', function() {
						this.style.borderColor = 'var(--border-color)';
					});
				});
			});
		</script>
	</body>
</html>